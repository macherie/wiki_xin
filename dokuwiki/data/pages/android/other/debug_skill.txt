====== Android休眠失败 ======
===== Android查看wakelocks占用: =====
用串口抓cat /proc/wakelocks > wakelocks.cap,然后用下面命令过滤\\
<code>cat wakelocks.cap | awk '{print $1 " " $5}' | grep -v " 0" | grep -v active</code> (过滤出第5位不是0不是列名的行)

如果/proc/wakelocks不存在，挂载debugfs,
<code>
mount -t debugfs debugfs /sys/kernel/debug
</code>

查看wakeup_sources有同样效果
<code>
adb shell cat /sys/kernel/debug/wakeup_sources > wake.txt
cat wake.txt | awk '{print $1 " " $5}' | grep -v " 0" | grep -v active
</code>

查看应用层的锁
<code>
root@s55:/ # cat /sys/power/wake_lock                                          
PowerManagerService.Display PowerManagerService.WakeLocks
</code>

===== Make crach 进入 Download mode =====
<code>
echo c > /proc/sysrq-trigger
</code>

\\
\\

 =====附:wakeup_sources详解=====
**1、wakeup_sources**\\
kernel wakelock和userspace wakelock都有可能阻止系统睡眠。所有的wakeup_sources均保存在sys节点/sys/kernel/debug/wakeup_sources里面。\\
该文件包含了如下信息：\\
（1）the total amount of time a wakeup source has prevented suspend\\
（2）the amount of time a wakelock has been active since the last activation etc. The unit of time is milliseconds.\\
\\
**2、active_since**\\
active_since值可以用来确认wakelock是否正在阻止休眠。如果该值不是零，那么这个wakelock正在工作并且阻止休眠。\\
\\
**3、获取wakeup_sources的命令**        \\
<code>
adb root 67754400
adb remount
adb shell
cat /sys/kernel/debug/wakeup_sources > /data/wakeup_sources.txt
adb pull /data/wakeup_sources.txt 
</code>
获得wakeup_sources.txt以后，通过Excel打开，active_since不为0的项为wakeup source。以表2为例，msm_dwc3对应的active-since值481756>0，这意味着msm_dwc3驱动在阻止系统睡眠，下一步需要检查msm_dwc3驱动代码及相关log。        \\
\\
**4、power:wakeup_source_activate and power:wakeup_source_deactivate events**        \\
当一个wakeup source被acquire或者release时候，power:wakeup_source_activate和power:wakeup_source_deactivate event将随即被写到trace buffer里面，这样可以记录wakeup source被driver使用的频率。        \\
开启该功能的方法：        \\
<code>echo “power:wakeup_source_activate power:wakeup_source_deactivate” > /sys/kernel/debug/tracing/set_event</code>
The power:wakeup_source_activate and power:wakeup_source_deactivate events are written to the trace buffer any time a wakeup source is acquired or released and it can provide information on how often a wakeup source is being used by a driver.        \\
To enable these events, you can enable following:        \\
<code>echo “power:wakeup_source_activate power:wakeup_source_deactivate” > /sys/kernel/debug/tracing/set_event </code>
Once the above done, the traces will be present in /sys/kernel/debug/tracing/trace.
