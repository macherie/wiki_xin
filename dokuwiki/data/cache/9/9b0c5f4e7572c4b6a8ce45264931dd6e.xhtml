
<p>
— <em><a href="mailto:&#x73;&#x68;&#x75;&#x2e;&#x79;&#x69;&#x6e;&#x40;&#x73;&#x69;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;" class="mail" title="&#x73;&#x68;&#x75;&#x2e;&#x79;&#x69;&#x6e;&#x40;&#x73;&#x69;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">尹姝</a> 2014/2/21</em>
</p>

<h1 class="sectionedit1" id="数据业务丢失问题分析报告">数据业务丢失问题分析报告</h1>
<div class="level1">
<div class="table sectionedit2"><table class="inline">
	<tr class="row0">
		<th class="col0 leftalign">Document Title:     </th><td class="col1">数据业务丢失问题分析报告</td>
	</tr>
	<tr class="row1">
		<th class="col0 leftalign">Version:            </th><td class="col1 leftalign">1.01               </td>
	</tr>
	<tr class="row2">
		<th class="col0 leftalign">Date:               </th><td class="col1 leftalign">2013-04-22         </td>
	</tr>
	<tr class="row3">
		<th class="col0 leftalign">Status:             </th><td class="col1 leftalign">Release            </td>
	</tr>
	<tr class="row4">
		<th class="col0">Document Control ID:</th><td class="col1 leftalign">SIM0001.pdf        </td>
	</tr>
	<tr class="row5">
		<th class="col0 leftalign">Writer:             </th><td class="col1 leftalign">Pengpeng           </td>
	</tr>
</table></div>
<!-- EDIT2 TABLE [97-378] --><hr />

</div>
<!-- EDIT1 SECTION "数据业务丢失问题分析报告" [46-387] -->
<h2 class="sectionedit3" id="问题描述">问题描述：</h2>
<div class="level2">

<p>
1) S100和Titan项目在使用过程中，出现过几次手机放置一晚，第二天不能上网的情况，右上角E(edge)或者3G的图标消失，查看手机状态显示Mobile network type为UNKNOWN。
</p>

<p>
2) Titan项目在测试过程中，有时候开机会一直未能成功注册数据业务，但是语音业务可以正常使用，打电话不受影响，无法上网，右上角显示信号条，但是不显示E(edge)或者3G图标，查看手机状态显示Mobile network type为UNKNOW。
</p>

</div>
<!-- EDIT3 SECTION "问题描述：" [388-918] -->
<h2 class="sectionedit4" id="问题分析">问题分析：</h2>
<div class="level2">

<p>
该问题较难复现，复现后AT+CFUN?查看状态正常，AT+CPIN?也显示SIM卡正常，而adb log仅能看出数据业务状态改变，无法准确定位。需要连续不断抓取QXDM log分析空口消息。
</p>

<p>
针对发现的问题的两种情况，从几次抓取的QXDM log看，导致手机无法注册数据业务的原因都一样，都是在使用过程中被网络端Detach的：
</p>
<pre class="code">OTA LOG    [0x713A/008/005]GMM/Detach Request     16:07:36.707     Direction: Network To MS, Length: 3
chan_type = 0 (0x0)
trans_id_or_skip_ind = 0 (0x0)
prot_disc = 8 (0x8) (GSM_GMM_MESSAGES)
msg_type = 5 (0x5)
prot
  gprs_mob_man_prot
    GMM_DETACH_REQUEST_MT
      force_stby
        force_standby_value = 0 (0x0)
      det_type
        power_off = 0 (0x0)
        type_of_detach = 2 (0x2)
      gmm_cause_incl = 0 (0x0)</pre>

<p>
查询3GPP 24008协议， 第10.5.5.5 Detach type明确规定如下：
</p>
<div class="table sectionedit5"><table class="inline">
	<tr class="row0">
		<th class="col0 leftalign" colspan="5">In the network to MS direction:                                                            </th>
	</tr>
	<tr class="row1">
		<th class="col0 leftalign" colspan="5">Bits                                                                                       </th>
	</tr>
	<tr class="row2">
		<td class="col0">3</td><td class="col1">2</td><td class="col2">1</td><td class="col3"> </td><td class="col4 leftalign">                                                                                        </td>
	</tr>
	<tr class="row3">
		<td class="col0">0</td><td class="col1">0</td><td class="col2">1</td><td class="col3"> </td><td class="col4 leftalign">re-attach required                                                                      </td>
	</tr>
	<tr class="row4">
		<td class="col0">0</td><td class="col1">1</td><td class="col2">0</td><td class="col3"> </td><td class="col4 leftalign">re-attach not required                                                                  </td>
	</tr>
	<tr class="row5">
		<td class="col0">0</td><td class="col1">1</td><td class="col2">1</td><td class="col3"> </td><td class="col4 leftalign">IMSI detach (after VLR failure)                                                         </td>
	</tr>
	<tr class="row6">
		<td class="col0 leftalign" colspan="5">                                                                                           </td>
	</tr>
	<tr class="row7">
		<td class="col0" colspan="5">All other values are interpreted as re-attach not required by this version of the protocol.</td>
	</tr>
</table></div>
<!-- EDIT5 TABLE [1852-2639] -->
<p>
根据协议，Qualcomm在NAS层收到网络端发起的Detach request后，先检测detach type, 如果不在规定的三种类型中，则默认为not required:
</p>

<p>
gmmmsg.c
</p>
<pre class="code c">boolean gmm_valid_mt_detach_request_message
<span class="br0">&#40;</span>
  mm_cmd_type                 <span class="sy0">*</span>message<span class="sy0">,</span>
  gmm_mt_detach_request_msg_T <span class="sy0">*</span>detach_request_msg
<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp;
....
&nbsp;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>detach_request_msg<span class="sy0">-&gt;</span>detach_type <span class="sy0">!=</span> GMM_REATTACH_REQUIRED<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span>
        <span class="br0">&#40;</span>detach_request_msg<span class="sy0">-&gt;</span>detach_type <span class="sy0">!=</span> GMM_REATTACH_NOT_REQUIRED<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span>
        <span class="br0">&#40;</span>detach_request_msg<span class="sy0">-&gt;</span>detach_type <span class="sy0">!=</span> GMM_MT_IMSI_DETACH<span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
      <span class="coMULTI">/* ----------------------------------------------------------
      ** All other values are interpreted as re-attach not required
      ** by this version of the protocol (24.008 Table 10.5.138)
      ** ---------------------------------------------------------- */</span>
      detach_request_msg<span class="sy0">-&gt;</span>detach_type <span class="sy0">=</span> GMM_REATTACH_NOT_REQUIRED<span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
....
&nbsp;
<span class="br0">&#125;</span></pre>

<p>
如果detach type为2即not required, 则手机端接受网络detach请求，释放数据业务。并通知AP端数据业务状态发生改变，应用层读取数据业务类型，发现变为UNKNOW，将待机界面之前的E(edge)或者3G图标去掉不再显示。
</p>

<p>
之后，用户如果想要使用数据业务，开启再关闭数据业务则无法恢复服务， 因为数据类型为UNKNOW，手机当前并未附着在任何基站小区上，无法进行注册，只能重启，或者开启再关闭飞行模式，让手机重新做一遍找网鉴权的流程。
</p>

</div>
<!-- EDIT4 SECTION "问题分析：" [919-4118] -->
<h2 class="sectionedit6" id="解决方案">解决方案：</h2>
<div class="level2">

<p>
鉴于Detach request发起自网络端，网络端的行为我们无法判断，如果仅仅参照3GPP协议，则这种情况是正常情况。但是该问题会影响用户使用，所以我们需要绕过协议，做一个妥协的处理。
</p>

<p>
我们尝试当网络端发起Detach request时，如果detach type类型为2(re-atttach not required)时，则修改为1(re-attach required)，去做至多三次Re-attach。
</p>
<pre class="code c">boolean gmm_valid_mt_detach_request_message
<span class="br0">&#40;</span>
  mm_cmd_type                 <span class="sy0">*</span>message<span class="sy0">,</span>
  gmm_mt_detach_request_msg_T <span class="sy0">*</span>detach_request_msg
<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
....
<span class="co1">// [SIMT-pengpeng-20130415] added to reattach even NW not required, begin</span>
  <span class="kw4">static</span> <span class="kw4">uint8</span>  reattach_count <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="co1">// [SIMT-pengpeng-20130415] added to reattach even NW not required, end</span>
....
&nbsp;
<span class="co1">// [SIMT-pengpeng-20130415] added to reattach even NW not required, begin</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>FALSE <span class="sy0">==</span> gmm_anite_gcf_flag<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="br0">&#40;</span>GMM_REATTACH_NOT_REQUIRED <span class="sy0">==</span> detach_request_msg<span class="sy0">-&gt;</span>detach_type<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="br0">&#40;</span><span class="nu0">3</span> <span class="sy0">&gt;</span> reattach_count<span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
      MSG_HIGH_DS<span class="br0">&#40;</span> MM_SUB<span class="sy0">,</span> <span class="st0">&quot;=MM= gmm_valid_mt_detach_request_message, detach_type = %d, gmm_state = %d, reattach_count = %d&quot;</span><span class="sy0">,</span> detach_request_msg<span class="sy0">-&gt;</span>detach_type<span class="sy0">,</span> gmm_state<span class="sy0">,</span> reattach_count <span class="br0">&#41;</span><span class="sy0">;</span>
      detach_request_msg<span class="sy0">-&gt;</span>detach_type <span class="sy0">=</span> GMM_REATTACH_REQUIRED<span class="sy0">;</span>
      reattach_count<span class="sy0">++;</span>
    <span class="br0">&#125;</span>
<span class="co1">// [SIMT-pengpeng-20130415] added to reattach even NW not required, end</span>
&nbsp;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>detach_request_msg<span class="sy0">-&gt;</span>detach_type <span class="sy0">!=</span> GMM_REATTACH_REQUIRED<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span>
        <span class="br0">&#40;</span>detach_request_msg<span class="sy0">-&gt;</span>detach_type <span class="sy0">!=</span> GMM_REATTACH_NOT_REQUIRED<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span>
        <span class="br0">&#40;</span>detach_request_msg<span class="sy0">-&gt;</span>detach_type <span class="sy0">!=</span> GMM_MT_IMSI_DETACH<span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
      <span class="coMULTI">/* ----------------------------------------------------------
      ** All other values are interpreted as re-attach not required
      ** by this version of the protocol (24.008 Table 10.5.138)
      ** ---------------------------------------------------------- */</span>
      detach_request_msg<span class="sy0">-&gt;</span>detach_type <span class="sy0">=</span> GMM_REATTACH_NOT_REQUIRED<span class="sy0">;</span>
    <span class="br0">&#125;</span>
....
<span class="br0">&#125;</span></pre>

<p>
注：gmm_anite_gcf_flag是一个测试标志位，在实验室使用测试卡做认证测试时，该标志位会被置为TRUE，其值保存于NV NV_GPRS_ANITE_GCF_I中，开机时会根据SIM卡类型写入。因此这里要对其进行判断，如果发现是插入测试卡时无需做此改动，否则无法通过相关的认证。
</p>

</div>
<!-- EDIT6 SECTION "解决方案：" [4119-] -->