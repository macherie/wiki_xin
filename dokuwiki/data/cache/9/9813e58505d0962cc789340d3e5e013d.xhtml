
<h1 class="sectionedit1" id="m_yuv_sensor_camera_拍照卡死">5M YUV sensor camera 拍照卡死</h1>
<div class="level1">

<p>
MSM8625Q平台上移植5M的 OV5640 Camera 会出现几个大小卡死。
</p>

<p>
<strong>主要原因：</strong>
</p>
<pre class="code">  VFE 在 设置 pixel crop info 的代码有bug。没有考虑大像素的 YUV sensor。
  计算 delta 值的时候错了，应该是大的减去小的。还有就是 YUV 的时候是2个byte，所以还要乘以2.</pre>

<p>
<strong>修改</strong>
</p>
<pre class="code diff">diff --git a/mm-camera/server/hardware/vfe/vfe2x/common/vfe.c b/mm-camera/server/hardware/vfe/vfe2x/common/vfe.c
index <span class="re0">75d93</span>db..59e4537 <span class="nu0">100755</span>
<span class="re3">--- a/mm-camera/server/hardware/vfe/vfe2x/common/vfe.c</span>
<span class="re4">+++ b/mm-camera/server/hardware/vfe/vfe2x/common/vfe.c</span>
<span class="re6">@@ -1517,6 +1517,7 @@ vfe_status_t vfe_set_pixel_crop_info<span class="br0">&#40;</span>vfe_ctrl_info_t *p_obj, void *parm<span class="br0">&#41;</span></span>
   vfe_sensor_params_t *sparams = &amp;<span class="br0">&#40;</span>p_obj-&gt;vfe_params.sensor_parms<span class="br0">&#41;</span>;
   vfe_active_region_t *active_params = &amp;<span class="br0">&#40;</span>p_obj-&gt;vfe_params.active_crop_info<span class="br0">&#41;</span>;
   uint32_t delta;
<span class="re8">+  uint32_t MaxVFEWidth = MAX_VFE_WIDTH; //for yuv sensor</span>
&nbsp;
   sparams-&gt;firstPixel =  info-&gt;first_pixel;
   sparams-&gt;lastPixel =  info-&gt;last_pixel;
<span class="re6">@@ -1526,9 +1527,7 @@ vfe_status_t vfe_set_pixel_crop_info<span class="br0">&#40;</span>vfe_ctrl_info_t *p_obj, void *parm<span class="br0">&#41;</span></span>
                               &amp;<span class="br0">&#40;</span>p_obj-&gt;vfe_params<span class="br0">&#41;</span><span class="br0">&#41;</span>;
   if <span class="br0">&#40;</span><span class="br0">&#40;</span>active_params-&gt;lastLine - active_params-&gt;firstLine + <span class="nu0">1</span><span class="br0">&#41;</span> &gt;
            MAX_VFE_HEIGHT<span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="re7">-                    delta = <span class="br0">&#40;</span>MAX_VFE_HEIGHT -</span>
<span class="re7">-                                <span class="br0">&#40;</span>active_params-&gt;lastLine -</span>
<span class="re7">-                                      active_params-&gt;firstLine + <span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span> / <span class="nu0">2</span>;</span>
<span class="re8">+                   delta = <span class="br0">&#40;</span><span class="br0">&#40;</span>active_params-&gt;lastLine -active_params-&gt;firstLine + <span class="nu0">1</span><span class="br0">&#41;</span>-MAX_VFE_HEIGHT<span class="br0">&#41;</span> / <span class="nu0">2</span>;</span>
                     p_obj-&gt;vfe_params.demosaic_op_params.first_line =
                                          active_params-&gt;firstLine + delta - <span class="nu0">1</span>;
                      p_obj-&gt;vfe_params.demosaic_op_params.last_line =
<span class="re6">@@ -1541,10 +1540,11 @@ vfe_status_t vfe_set_pixel_crop_info<span class="br0">&#40;</span>vfe_ctrl_info_t *p_obj, void *parm<span class="br0">&#41;</span></span>
                                       active_params-&gt;lastLine;
   <span class="br0">&#125;</span>
&nbsp;
<span class="re7">-  if <span class="br0">&#40;</span><span class="br0">&#40;</span>active_params-&gt;lastPixel - active_params-&gt;firstPixel + 1<span class="br0">&#41;</span> &gt;</span>
<span class="re7">-             MAX_VFE_WIDTH<span class="br0">&#41;</span> <span class="br0">&#123;</span></span>
<span class="re7">-                delta = <span class="br0">&#40;</span>MAX_VFE_WIDTH -</span>
<span class="re7">-                   <span class="br0">&#40;</span>active_params-&gt;lastPixel - active_params-&gt;firstPixel + <span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span> / <span class="nu0">2</span>;</span>
<span class="re8">+  if <span class="br0">&#40;</span>p_obj-&gt;vfe_params.sensor_parms.vfe_snsr_fmt == SENSOR_YCBCR<span class="br0">&#41;</span> // for yuv sensor</span>
<span class="re8">+       MaxVFEWidth *=<span class="nu0">2</span>; // for yuv sensor</span>
<span class="re8">+</span>
<span class="re8">+  if <span class="br0">&#40;</span><span class="br0">&#40;</span>active_params-&gt;lastPixel - active_params-&gt;firstPixel + 1<span class="br0">&#41;</span> &gt; MaxVFEWidth<span class="br0">&#41;</span> <span class="br0">&#123;</span></span>
<span class="re8">+               delta = <span class="br0">&#40;</span><span class="br0">&#40;</span>active_params-&gt;lastPixel - active_params-&gt;firstPixel + <span class="nu0">1</span><span class="br0">&#41;</span>-MaxVFEWidth<span class="br0">&#41;</span> / <span class="nu0">2</span>;</span>
                 p_obj-&gt;vfe_params.demosaic_op_params.first_pixel =
                 active_params-&gt;firstPixel + delta - <span class="nu0">1</span>;
                 p_obj-&gt;vfe_params.demosaic_op_params.last_pixel =</pre>

<p>
<strong>修改后的 vfe_set_pixel_crop_info：</strong>
</p>
<dl class="file">
<dt><a href="/dokuwiki/doku.php?do=export_code&amp;id=platform:8625q:issues:5m_yuv_camera%E6%8B%8D%E7%85%A7%E5%8D%A1%E6%AD%BB&amp;codeblock=1" title="下载片段" class="mediafile mf_c">vfe_set_pixel_crop_info.c</a></dt>
<dd><pre class="code file c">vfe_status_t vfe_set_pixel_crop_info<span class="br0">&#40;</span>vfe_ctrl_info_t <span class="sy0">*</span>p_obj<span class="sy0">,</span> <span class="kw4">void</span> <span class="sy0">*</span>parm<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  pixel_crop_info_t <span class="sy0">*</span>info <span class="sy0">=</span> <span class="br0">&#40;</span>pixel_crop_info_t <span class="sy0">*</span><span class="br0">&#41;</span>parm<span class="sy0">;</span>
  vfe_sensor_params_t <span class="sy0">*</span>sparams <span class="sy0">=</span> <span class="sy0">&amp;</span><span class="br0">&#40;</span>p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">sensor_parms</span><span class="br0">&#41;</span><span class="sy0">;</span>
  vfe_active_region_t <span class="sy0">*</span>active_params <span class="sy0">=</span> <span class="sy0">&amp;</span><span class="br0">&#40;</span>p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">active_crop_info</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="kw4">uint32_t</span> delta<span class="sy0">;</span>
  <span class="kw4">uint32_t</span> MaxVFEWidth <span class="sy0">=</span> MAX_VFE_WIDTH<span class="sy0">;</span> <span class="co1">//for yuv sensor</span>
&nbsp;
  sparams<span class="sy0">-&gt;</span>firstPixel <span class="sy0">=</span>  info<span class="sy0">-&gt;</span>first_pixel<span class="sy0">;</span>
  sparams<span class="sy0">-&gt;</span>lastPixel <span class="sy0">=</span>  info<span class="sy0">-&gt;</span>last_pixel<span class="sy0">;</span>
  sparams<span class="sy0">-&gt;</span>firstLine <span class="sy0">=</span>  info<span class="sy0">-&gt;</span>first_line<span class="sy0">;</span>
  sparams<span class="sy0">-&gt;</span>lastLine <span class="sy0">=</span>  info<span class="sy0">-&gt;</span>last_line<span class="sy0">;</span>
  vfe_init_active_crop_info<span class="br0">&#40;</span><span class="sy0">&amp;</span><span class="br0">&#40;</span>p_obj<span class="sy0">-&gt;</span>vfe_module.<span class="me1">active_crop_mod</span><span class="br0">&#41;</span><span class="sy0">,</span>
                              <span class="sy0">&amp;</span><span class="br0">&#40;</span>p_obj<span class="sy0">-&gt;</span>vfe_params<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>active_params<span class="sy0">-&gt;</span>lastLine <span class="sy0">-</span> active_params<span class="sy0">-&gt;</span>firstLine <span class="sy0">+</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span>
           MAX_VFE_HEIGHT<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    delta <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>active_params<span class="sy0">-&gt;</span>lastLine <span class="sy0">-</span>active_params<span class="sy0">-&gt;</span>firstLine <span class="sy0">+</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">-</span>MAX_VFE_HEIGHT<span class="br0">&#41;</span> <span class="sy0">/</span> <span class="nu0">2</span><span class="sy0">;</span>
                    p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">first_line</span> <span class="sy0">=</span>
                                         active_params<span class="sy0">-&gt;</span>firstLine <span class="sy0">+</span> delta <span class="sy0">-</span> <span class="nu0">1</span><span class="sy0">;</span>
                     p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">last_line</span> <span class="sy0">=</span>
                                              active_params<span class="sy0">-&gt;</span>lastLine <span class="sy0">-</span> delta<span class="sy0">;</span>
     <span class="br0">&#125;</span>              
  <span class="kw1">else</span> <span class="br0">&#123;</span>                                 
    p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">first_line</span> <span class="sy0">=</span>
                                     active_params<span class="sy0">-&gt;</span>firstLine<span class="sy0">;</span>
    p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">last_line</span> <span class="sy0">=</span>
                                      active_params<span class="sy0">-&gt;</span>lastLine<span class="sy0">;</span>
  <span class="br0">&#125;</span> 
&nbsp;
  <span class="kw1">if</span> <span class="br0">&#40;</span>p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">sensor_parms</span>.<span class="me1">vfe_snsr_fmt</span> <span class="sy0">==</span> SENSOR_YCBCR<span class="br0">&#41;</span> <span class="co1">// for yuv sensor</span>
        MaxVFEWidth <span class="sy0">*=</span><span class="nu0">2</span><span class="sy0">;</span> <span class="co1">// for yuv sensor</span>
&nbsp;
  <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>active_params<span class="sy0">-&gt;</span>lastPixel <span class="sy0">-</span> active_params<span class="sy0">-&gt;</span>firstPixel <span class="sy0">+</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy0">&gt;</span> MaxVFEWidth<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                delta <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>active_params<span class="sy0">-&gt;</span>lastPixel <span class="sy0">-</span> active_params<span class="sy0">-&gt;</span>firstPixel <span class="sy0">+</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">-</span>MaxVFEWidth<span class="br0">&#41;</span> <span class="sy0">/</span> <span class="nu0">2</span><span class="sy0">;</span>
                p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">first_pixel</span> <span class="sy0">=</span>
                active_params<span class="sy0">-&gt;</span>firstPixel <span class="sy0">+</span> delta <span class="sy0">-</span> <span class="nu0">1</span><span class="sy0">;</span>
                p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">last_pixel</span> <span class="sy0">=</span>
                active_params<span class="sy0">-&gt;</span>lastPixel <span class="sy0">-</span> delta<span class="sy0">;</span>
  <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>      
     p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">first_pixel</span> <span class="sy0">=</span>
                                      active_params<span class="sy0">-&gt;</span>firstPixel<span class="sy0">;</span>
    p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">last_pixel</span> <span class="sy0">=</span>
                                       active_params<span class="sy0">-&gt;</span>lastPixel<span class="sy0">;</span>
  <span class="br0">&#125;</span>  
&nbsp;
  p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">first_pixel</span> <span class="sy0">+=</span> DEMOSAIC_WIDTH_DELTA<span class="sy0">/</span><span class="nu0">2</span><span class="sy0">;</span>
  p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">last_pixel</span> <span class="sy0">-=</span> DEMOSAIC_WIDTH_DELTA<span class="sy0">/</span><span class="nu0">2</span><span class="sy0">;</span>
  p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">first_line</span> <span class="sy0">+=</span> DEMOSAIC_HEIGHT_DELTA<span class="sy0">/</span><span class="nu0">2</span><span class="sy0">;</span>
  p_obj<span class="sy0">-&gt;</span>vfe_params.<span class="me1">demosaic_op_params</span>.<span class="me1">last_line</span> <span class="sy0">-=</span> DEMOSAIC_HEIGHT_DELTA<span class="sy0">/</span><span class="nu0">2</span><span class="sy0">;</span>
&nbsp;
  <span class="kw1">return</span> VFE_SUCCESS<span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</dd></dl>

</div>
