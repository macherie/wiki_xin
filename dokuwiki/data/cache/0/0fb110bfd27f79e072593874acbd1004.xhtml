
<p>
If you have been using Theme.NoDisplay in one or more activities in your app, and you have not tested them on Android 6.0 yet, I recommend that you do so soon. An undocumented regression in Android 6.0 will cause some of those activities to crash upon launch, if your targetSdkVersion is 23 or higher.
</p>

<p>
If the activity does all of its work in onCreate() (e.g., starts up a service), then calls finish(), you seem to be OK.
</p>

<p>
But sometimes the work that needs to be done is a bit more involved than that. In particular, calling startActivityForResult(), with an eye towards calling finish() in onActivityResult(), will cause your app to crash with an IllegalStateException saying that your activity “did not call finish() prior to onResume() completing”. This, apparently, is a new requirement of Theme.NoDisplay activities.
</p>

<p>
You might wonder why you need a Theme.NoDisplay activity to be calling startActivityForResult() in the first place. The scenario I encountered was trying to use the media projection APIs, specifically to set up recording a screencast. To use the media projection APIs, you need to call startActivityForResult() on a system-supplied Intent, then use the result data to set up a MediaProjection. In the case of this sample app, the user interface was primarily going to be a foreground Notification of a service (plus some command-line scripts), so I had no need for an activity, except as a means of enabling the media projection APIs.
</p>

<p>
So, I have something like this:
</p>
<pre class="code java"><span class="kw1">package</span> <span class="co2">com.commonsware.android.andcorder</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">import</span> <span class="co2">android.app.Activity</span><span class="sy0">;</span>
<span class="kw1">import</span> <span class="co2">android.content.Intent</span><span class="sy0">;</span>
<span class="kw1">import</span> <span class="co2">android.media.projection.MediaProjectionManager</span><span class="sy0">;</span>
<span class="kw1">import</span> <span class="co2">android.os.Bundle</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">public</span> <span class="kw1">class</span> MainActivity <span class="kw1">extends</span> Activity <span class="br0">&#123;</span>
  <span class="kw1">private</span> <span class="kw1">static</span> <span class="kw1">final</span> <span class="kw4">int</span> REQUEST_SCREENSHOT<span class="sy0">=</span><span class="nu0">59706</span><span class="sy0">;</span>
  <span class="kw1">private</span> MediaProjectionManager mgr<span class="sy0">;</span>
&nbsp;
  @Override
  <span class="kw1">protected</span> <span class="kw4">void</span> onCreate<span class="br0">&#40;</span>Bundle savedInstanceState<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">super</span>.<span class="me1">onCreate</span><span class="br0">&#40;</span>savedInstanceState<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    mgr<span class="sy0">=</span><span class="br0">&#40;</span>MediaProjectionManager<span class="br0">&#41;</span>getSystemService<span class="br0">&#40;</span>MEDIA_PROJECTION_SERVICE<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    startActivityForResult<span class="br0">&#40;</span>mgr.<span class="me1">createScreenCaptureIntent</span><span class="br0">&#40;</span><span class="br0">&#41;</span>,
      REQUEST_SCREENSHOT<span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
&nbsp;
  @Override
  <span class="kw1">protected</span> <span class="kw4">void</span> onActivityResult<span class="br0">&#40;</span><span class="kw4">int</span> requestCode, <span class="kw4">int</span> resultCode, Intent data<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span>requestCode<span class="sy0">==</span>REQUEST_SCREENSHOT<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">if</span> <span class="br0">&#40;</span>resultCode<span class="sy0">==</span>RESULT_OK<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Intent i<span class="sy0">=</span>
            <span class="kw1">new</span> Intent<span class="br0">&#40;</span><span class="kw1">this</span>, RecorderService.<span class="kw1">class</span><span class="br0">&#41;</span>
                .<span class="me1">putExtra</span><span class="br0">&#40;</span>RecorderService.<span class="me1">EXTRA_RESULT_CODE</span>, resultCode<span class="br0">&#41;</span>
                .<span class="me1">putExtra</span><span class="br0">&#40;</span>RecorderService.<span class="me1">EXTRA_RESULT_INTENT</span>, data<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        startService<span class="br0">&#40;</span>i<span class="br0">&#41;</span><span class="sy0">;</span>
      <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&nbsp;
    finish<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>

<p>
This works just fine with Theme.NoDisplay on Android 5.1, passing control to my RecorderService to actually manage starting and stopping the screen recording. On Android 6.0, the app crashes with the aforementioned exception.
</p>

<p>
Another scenario is using requestPermissions() from the Android 6.0 runtime permission system. Under the covers, requestPermissions() uses startActivityForResult(). If you have an app where the UI is mostly not an activity (e.g., app widget, Notification, wear app), but you need runtime permissions, you might try creating a Theme.NoDisplay activity just to call requestPermissions() and handle onRequestPermissionsResult(). I would expect this to generate the same exception on Android 6.0, though I have not tried this scenario to confirm the theory.
</p>

<p>
The issue that was filed on the M Developer Preview about this ran into the problem when trying to show a Dialog from onCreate(). The issue went nowhere.
</p>

<p>
One fix described in that issue — calling setVisible(true) in onStart() — works, but you wind up with a visible activity UI (black background and old-timey gray title bar).
</p>

<p>
What worked better for me was to use Theme.Translucent.NoTitleBar as the theme on Android 6.0+. If you want to stick with Theme.NoDisplay on older devices, create a custom theme that inherits from Theme.NoDisplay in res/values/ but from Theme.Translucent.NoTitleBar in res/values-v23/, then use your custom theme.
</p>

<p>
Or, go with targetSdkVersion 22 temporarily. Eventually, something will drive you to using targetSdkVersion of 23 or higher, though.
</p>

<p>
UPDATE: 2015-11-08 Dianne Hackborn responded to this post, explaining that Theme.NoDisplay is somewhat documented to require a finish() before onResume() and outlines a bit of the rationale for the change to detect this case and fail fast. She and I disagree on what constitutes a regression (<abbr title="In my humble opinion">IMHO</abbr>, a substantial change in behavior is a regression, even if documentation hints at the validity of the change), but it is great that we have a more-or-less official source for what is going on.
</p>
