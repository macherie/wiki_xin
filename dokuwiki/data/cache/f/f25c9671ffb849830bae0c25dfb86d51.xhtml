
<h1 class="sectionedit1" id="预充电">1. 预充电</h1>
<div class="level1">
<pre class="code"> 在完成基本的初始化工作以后，系统需要检查供电系统，包括Battery及Battery Debug Board是否存在，Charger是否存在及Charger类型等，调用关系如下:
 sbl1_hw_init_secondary()-&gt;boot_pm_driver_init()-&gt;pm_driver_post_init()-&gt;pm_chg_sbl_charging_init()</pre>

</div>
<!-- EDIT1 SECTION "1. 预充电" [1-318] -->
<h1 class="sectionedit2" id="charging_init">2. Charging Init</h1>
<div class="level1">
<pre class="code"> sbl_chg_app_ds =(uint16*)pm_target_information_get_module_lut_info(CHG_APP, NULL);
 获取充电算法的指定数据，sbl_chg_app_ds的取值为pm_config_target.c里面的chg_app_ds</pre>
<pre class="code c">   <span class="kw4">uint16</span> chg_app_ds<span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#123;</span>
   <span class="nu0">3500</span><span class="sy0">,</span>    <span class="co1">//PM_CHG_FLCB_OS_BOOT_UP_THRESHOLD   可以通过修改此值来改变开机电压值</span>
   <span class="nu0">3200</span><span class="sy0">,</span>    <span class="co1">//PM_CHG_FLCB_WEAK_BATTERY_THRESHOLD</span>
   <span class="nu0">2900</span><span class="sy0">,</span>    <span class="co1">//PM_CHG_FLCB_FAST_CHG_THRESHOLD</span>
   <span class="nu0">2800</span><span class="sy0">,</span>    <span class="co1">//PM_CHG_FLCB_DEAD_BATTERY_THRESHOLD</span>
    <span class="nu0">500</span><span class="sy0">,</span>     <span class="co1">// PM_CHG_DC_CHARGER_IMAX</span>
   <span class="nu0">1050</span><span class="sy0">,</span>    <span class="co1">// PM_CHG_IMAX_DEFAULT</span>
   <span class="nu0">1500</span><span class="sy0">,</span>    <span class="co1">// PM_CHG_USB_IDEV_DCHG</span>
   <span class="nu0">1500</span><span class="sy0">,</span>    <span class="co1">//PM_CHG_USB_IUSB_NON_COMPLIANT_DCP</span>
    <span class="nu0">500</span><span class="sy0">,</span>     <span class="co1">// PM_CHG_USB_IDEV_SDP</span>
     <span class="nu0">90</span><span class="sy0">,</span>     <span class="co1">// PM_CHG_USB_IUNIT</span>
     <span class="nu0">45</span><span class="sy0">,</span>     <span class="co1">// PM_CHG_USB_TRKL_TIMEOUT</span>
   <span class="nu0">2050</span><span class="sy0">,</span>    <span class="co1">// PM_CHG_VBAT_TRKL_MIN_THRESHOLD</span>
   <span class="nu0">2100</span><span class="sy0">,</span>    <span class="co1">//PM_CHG_VBAT_WEAK_MIN_THRESHOLD</span>
   <span class="nu0">3600</span><span class="sy0">,</span>    <span class="co1">//PM_CHG_VBAT_WEAK_MAX_THRESHOLD</span>
   <span class="nu0">3500</span><span class="sy0">,</span>    <span class="co1">//PM_CHG_FLCB_OS_BOOTUP_AFTER_USB_SUSPEND_THRESHOLD. </span>
      <span class="nu0">0</span><span class="sy0">,</span>     <span class="co1">// PM_CHG_PMIC_DEVICE_INDEX</span>
      <span class="nu0">1</span>     <span class="co1">//PM_CHG_INTERNAL_PMIC_CHARGER_USED</span>
   <span class="br0">&#125;</span><span class="sy0">;</span></pre>
<pre class="code"> pm_smbb_chg_get_internal_charger_present()
 检测Internal Charger是否存在，最终会调用pm_smbb_chg_get_internal_charger_present_alg()；
 注意：如果使用外部充电芯片的话，此处应该修改为直接返回True，否则可能导致板子不停重启；
 
 pm_chg_sbl_charging_state_entry()
 如果内部充电存在，则会进一步检查供电系统；
 
 pm_chg_dvdd_hard_reset()
 如果内部充电不存在，则会执行重启；
 </pre>

</div>
<!-- EDIT2 SECTION "2. Charging Init" [319-1871] -->
<h1 class="sectionedit3" id="检测battery和debug_board状态">3.检测Battery和Debug  Board状态</h1>
<div class="level1">
<pre class="code"> 1: 如果Debug Board存在，则执行启动流程（当然这里是不存在的）</pre>
<pre class="code c">   <span class="kw1">if</span><span class="br0">&#40;</span> debug_board_present<span class="sy0">==</span> TRUE<span class="br0">&#41;</span> <span class="br0">&#123;</span>
       next_state_ptr <span class="sy0">=</span> <span class="sy0">&amp;</span>pm_chg_state__bootup_ok<span class="sy0">;</span>  <span class="co1">//Bootup OK</span>
<span class="br0">&#125;</span></pre>
<pre class="code"> 2: 如果电池也不存在，则设置USB输出最大电流（500mA）注S700项目遇到电池没接ID脚，会识别电池不存在,会造成无论电池电压多少，都会开机，
 如果插入低功率的充电器的话，会造成重复的开关机.</pre>
<pre class="code c"><span class="kw1">if</span><span class="br0">&#40;</span> battery_present <span class="sy0">==</span>FALSE<span class="br0">&#41;</span>
<span class="br0">&#123;</span>      <span class="co1">//No battery presence is detected</span>
       err_flag <span class="sy0">|=</span> pm_smbb_chg_set_iusb_max<span class="br0">&#40;</span>device_index<span class="sy0">,</span> PM_SMBB_1<span class="sy0">,</span> \
               sbl_chg_app_ds<span class="br0">&#91;</span>PM_CHG_USB_IDEV_DCHG<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
       next_state_ptr <span class="sy0">=</span> <span class="sy0">&amp;</span>pm_chg_state__bootup_ok<span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
<pre class="code"> 3: 如果电池存在，则检查是否低电，低电则进入充电模式，否则执行开机流程</pre>
<pre class="code c">pm_err_flag_type pm_chg_is_battery_weak<span class="br0">&#40;</span>boolean  <span class="sy0">*</span>battery_weak<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    pm_err_flag_type err_flag <span class="sy0">=</span> PM_ERR_FLAG__SUCCESS<span class="sy0">;</span>
    <span class="kw4">uint32</span> batt_voltage <span class="sy0">=</span> <span class="nu12">0x0</span><span class="sy0">;</span> 
&nbsp;
    err_flag <span class="sy0">=</span> pm_chg_get_battery_volt_level<span class="br0">&#40;</span><span class="sy0">&amp;</span>batt_voltage<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">if</span><span class="br0">&#40;</span>err_flag <span class="sy0">==</span> PM_ERR_FLAG__SUCCESS<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>   
        pm_chg_status.<span class="me1">batt_level</span> <span class="sy0">=</span> batt_voltage<span class="sy0">;</span>  <span class="co1">//update global var</span>
&nbsp;
        <span class="kw1">if</span><span class="br0">&#40;</span>batt_voltage <span class="sy0">&lt;</span> sbl_chg_app_ds<span class="br0">&#91;</span>PM_CHG_FLCB_OS_BOOT_UP_THRESHOLD<span class="br0">&#93;</span><span class="br0">&#41;</span>
        <span class="br0">&#123;</span>   
            <span class="sy0">*</span>battery_weak <span class="sy0">=</span> TRUE<span class="sy0">;</span>  <span class="co1">//battery is weak</span>
        <span class="br0">&#125;</span>   
        <span class="kw1">else</span>
        <span class="br0">&#123;</span>   
            <span class="sy0">*</span>battery_weak <span class="sy0">=</span> FALSE<span class="sy0">;</span>  <span class="co1">//battery is good</span>
        <span class="br0">&#125;</span>   
    <span class="br0">&#125;</span>                                                                                                                                             
&nbsp;
    <span class="kw1">return</span> err_flag<span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
<pre class="code"> 如果电池低电的话，接下来就是检查DCCharger或者USB Charger是否存在，如果存在则执行充电流程，不存在则关机，
 详细可以参考pm_chg_state__charger_type_detect；
 4: 预充电
 以USB充电为例，下面简单介绍下预充电的流程：</pre>
<pre class="code c"><span class="kw1">while</span><span class="br0">&#40;</span> battery_weak<span class="br0">&#41;</span>  <span class="co1">//While battery is in weak state</span>
<span class="br0">&#123;</span>
       <span class="co1">// Check for batterydisconnection</span>
       err_flag <span class="sy0">|=</span> pm_chg_is_battery_present<span class="br0">&#40;</span><span class="sy0">&amp;</span>battery_present<span class="br0">&#41;</span><span class="sy0">;</span>
       <span class="kw1">if</span><span class="br0">&#40;</span>err_flag <span class="sy0">==</span> PM_ERR_FLAG__SUCCESS<span class="br0">&#41;</span>
       <span class="br0">&#123;</span>
              <span class="kw1">if</span><span class="br0">&#40;</span>battery_present <span class="sy0">==</span> FALSE<span class="br0">&#41;</span> <span class="co1">//Battery is disconnected</span>
              <span class="br0">&#123;</span>
                     next_state_ptr <span class="sy0">=</span> <span class="sy0">&amp;</span>pm_chg_state__bootup_ok<span class="sy0">;</span><span class="co1">//boot up without battery</span>
                     <span class="kw2">break</span><span class="sy0">;</span>
              <span class="br0">&#125;</span>
       <span class="br0">&#125;</span>
&nbsp;
       <span class="co1">//Check USB chargerpresence</span>
       err_flag <span class="sy0">=</span>pm_chg_is_usb_charger_present<span class="br0">&#40;</span><span class="sy0">&amp;</span>usb_charger_present<span class="br0">&#41;</span><span class="sy0">;</span>
       <span class="kw1">if</span><span class="br0">&#40;</span> <span class="br0">&#40;</span>usb_charger_present <span class="sy0">==</span> FALSE<span class="br0">&#41;</span> <span class="sy0">||</span> <span class="br0">&#40;</span>err_flag <span class="sy0">!=</span>PM_ERR_FLAG__SUCCESS<span class="br0">&#41;</span> <span class="br0">&#41;</span>
       <span class="br0">&#123;</span>
              err_flag <span class="sy0">|=</span> pm_smbb_chg_set_mode<span class="br0">&#40;</span>device_index<span class="sy0">,</span>PM_SMBB_1<span class="sy0">,</span> \
                                                 PM_SMBB_CHG_MODE__CHARGE_OFF<span class="br0">&#41;</span><span class="sy0">;</span>
              next_state_ptr <span class="sy0">=</span> <span class="sy0">&amp;</span>pm_chg_state__shutdown<span class="sy0">;</span>
              battery_weak <span class="sy0">=</span> TRUE<span class="sy0">;</span>
              <span class="kw2">break</span><span class="sy0">;</span>
       <span class="br0">&#125;</span>
&nbsp;
       <span class="co1">//Enable chargingand LED blinking</span>
       toggle_led <span class="sy0">=</span> <span class="sy0">!</span>toggle_led<span class="sy0">;</span>
       err_flag <span class="sy0">|=</span> pm_chg_sbl_enable_led<span class="br0">&#40;</span>device_index<span class="sy0">,</span> toggle_led<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
       DALSYS_BusyWait<span class="br0">&#40;</span><span class="nu0">1000</span><span class="sy0">*</span><span class="nu0">500</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// Poll every 500ms</span>
&nbsp;
       <span class="co1">//Check battery weakstate</span>
       err_flag <span class="sy0">|=</span> pm_chg_is_battery_weak<span class="br0">&#40;</span><span class="sy0">&amp;</span>battery_weak<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
<pre class="code"> 从上面的代码能看出，在充电循环里面先后检查了Battery和USB Charger是否存在，不存在则会退出循环，
 同时LED灯会有红色闪烁，最后检查低电，当电池电压大于3.5v时，系统启动；  </pre>

</div>
<!-- EDIT3 SECTION "3.检测Battery和Debug  Board状态" [1872-] -->