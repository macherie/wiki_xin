
<h1 class="sectionedit1" id="基于adsp_sensor架构">基于adsp sensor架构</h1>
<div class="level1">

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=platform%3A892x%3Aadsp_sensors&amp;media=linux:892x:sensor1.png" class="media" title="linux:892x:sensor1.png"><img src="/dokuwiki/lib/exe/fetch.php?media=linux:892x:sensor1.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=platform%3A892x%3Aadsp_sensors&amp;media=linux:892x:sns_arch.png" class="media" title="linux:892x:sns_arch.png"><img src="/dokuwiki/lib/exe/fetch.php?media=linux:892x:sns_arch.png" class="media" alt="" /></a>
</p>

</div>
<!-- EDIT1 SECTION "基于adsp sensor架构" [1-97] -->
<h2 class="sectionedit2" id="代码路径">代码路径</h2>
<div class="level2">

<p>
1.kernel/arch/arm/mach-msm/sensors_adsp.c
</p>
<pre class="code"> 主要是通过PIL load adsp的image,以及为sensor framework提供一些API.</pre>

<p>
2.vendor/qcom/proprietary/sensors/dsps/*
</p>
<pre class="code">  dsps目录下主要包含了HAL, sensordaemon, libsensor1, 以及test相关的代码.
  HAL自然是为framework那边对接, 提供相关接口.
  sensordaemon主要负责与ADSP侧交互,是通过QMI的接口.
  libsensor1主要是提供接口为sensor client  sensd/receive sensor message from/to sensordaemon.
  test相关代码包括了功能测试,sensor校准等相关,关注QSensorTest.apk.</pre>

<p>
3.Non-HLOS/adsp_proc/*
</p>
<pre class="code"> 整个adsp侧代码都在此,adsp架构包括SMGR, SAM, SCM, DD等模块.调试过程中主要在SMGR和DD. 
 SMGR管理所有sensor的电源管理,sensor配置,sensor采样频率,数据上报等, DD则就是所有支持的sensors的 driver层.</pre>

</div>
<!-- EDIT2 SECTION "代码路径" [98-972] -->
<h2 class="sectionedit3" id="s55_g55_sensors_相关bug">S55/G55 Sensors 相关bug</h2>
<div class="level2">

<p>
1.问题描述:
工厂那边报告装机前测试过正常的板子装上整机或者放一段时间后所有的sensors都不工作了.
</p>

<p>
刚开始从产线带过来一台整机分析,整机确认所有sensors都不工作,通过sns_cm_test来测试也读取不到数据,这样就确认了与软件HAL层以上没有关系.确认/data/misc/sensors/sns.reg这个文件存在并且读写权限正常,并且运行sns_regedit_ssi -r来看当前sensors的配置情况,一切正常.
</p>

<p>
然后准备打开adsp侧log来看是否有有用的debug信息,至于adsp侧如何打开debug,请见文末debug方法.
在qxdm的log中果然看到有错误的log, 是sensors driver中写寄存器时i2c错误. 一般遇到i2c错误无非就是电没上或者i2c被拉死了,所以准备找硬件量电和抓i2c波形.
</p>

<p>
然后就悲剧了,拆机后所有sensors正常工作了….好吧,初步怀疑哪里短路了…然后就再也复现不出来了,装上整机也复现不出来…
</p>

<p>
好吧,接下来和硬件一起去了工厂分析这个问题, 到工厂后果然一批板子sensors都不工作,好吧,开量, 电都有, i2c波形悲剧了, clk线和data线同高同低,感觉被哪里短了,到这里基本可以确定是硬件问题了,但是不清楚哪个sensor或者器件把i2c搞成了这样.
</p>

<p>
然后我们罪恶的拆挂在i2c上的东西,拆拆拆,到对吼发现是几个TVS管的问题,原来是他们在DVT时换了TVS的替换料,而原先用的TVS和现在用的TVS封装上不兼容,焊盘尺寸都不一样,结果很有可能造成短路问题…
</p>

<p>
2.问题描述:
 客户报告概率性出现所有的sensors都不工作的情况,一旦不工作了,必须重新烧录代码才能正常, 关机休眠唤醒恢复出厂设置等都没有作用.
</p>

<p>
 刚开始一直担心是上面TVS短路那个问题,如果这样就没办法解决了,但是客户很肯定的说重新烧录代码就会好,如果真这样的话那应该是可以解决的,但是我们这边死活复现不出来,客户那边复现出来抓取的log又没有有价值含量的信息… 低概率性的问题很难熬，终于在一块板子上发现了个很奇怪的问题，现象也是所有sensors都不工作，但是用sns_cm_test测试下来发现只有g-sensor拿不到数据，别的sensors都可以拿到数据，而高通的设计是当g-sensor不工作的时候所有的sensors hal以上都没办法拿到数据了，造成的假象就是所有的sensors不工作！这个问题可以通过注释掉依赖g-sensor的几个API来使得别的sensors能正常工作，具体注释哪几个API见gerrit提交。怀疑客户遇到的问题就是g sensor不工作导致所有sensors不工作。
</p>

<p>
量电正常，i2c clk data都有！很崩溃不知道g sensor哪里出问题了。然后在多次实验后发现个规律，当接着TP时g sensor很大概率不工作，拿掉tp,重启g sensor就工作了。应该是TP哪里影响到了g sensor，而TP和所有的sensors是共用lvs1这路1.8V的电。可是当adsp image被load前这路电量着是有的啊，别的sensors也都能工作，从这点来讲不应该是电有问题啊。。。纠结中。
</p>

<p>
看来还是得从log看起，跟踪到底是g sensor死在了哪里。qxdm打出来的log很少，没有有价值的信息，只能从hal侧log看起。
</p>

<p>
enable所有hal侧的debug mask，具体方法见文末。
</p>

<p>
因为我们已经知道了只有g sensor不工作，为了避免其他sensors的log干扰，我们在sensor的配置文件中只留了g sensor，其他的sensors全部拿掉了。
</p>

<p>
在log里看到get_sensors_list时发现Error: No sensors found。 Number of sensors: 0。具体代码在sensors_qcom_hal.c中的_hal_sensors_get_sensors_list。为什么拿到的sensors_list_len=0呢，如果探测到了gsensor,应该number为1。又是怎么知道系统支持的哪些sensors呢？
</p>

<p>
3.问题描述：
在较新的版本上出现了最初2.5k机器有的出现概率性的开不了机的情况，机器停留在开机logo的界面，如果能开机发现sensor无功能。抓了log分析发现以下log：
</p>
<pre class="code">01-01 13:20:39.794 E/libsensor1(  226): sensor1_open: Error in connect() errno=2 No such file or directory
01-01 13:20:39.794 E/gsiff_dmn(  226): I/main: Pending Sensor1 connection opening!
01-01 13:20:39.794 E/gpsone_dmn(  226): gpsone_glue_pipeget:46] /data/misc/location/gsiff/gsiff_ctrl_q, mode = 2
01-01 13:20:39.794 W/Resources(  201): Preloaded drawable resource #0x10800fa (android:drawable/btn_check_on_disabled_focused_holo_dark) that varies with configuration!!
01-01 13:20:39.794 E/gpsone_dmn(  226): gpsone_glue_pipeget:65] fd = 11, /data/misc/location/gsiff/gsiff_ctrl_q
01-01 13:20:39.794 E/gsiff_sp_sns1(  226): I/sp_sns1_init: Initializing Sensor1
01-01 13:20:39.794 E/gsiff_sp_sns1(  226): W/sensor process is not up and running yet!
01-01 13:20:39.794 I/QCNEA   (  215): |CAC| [CNE CLIENT STATE MACHINE] transition CONNECTED_PENDING_PERM_RESPONSE -&gt; CONNECTED_ACCESS_ALLOWED
01-01 13:20:39.794 D/QCNEA   (  215): |CAC| readCallback: read len:0, ret:-1, errno:11
01-01 13:20:39.794 I/wcnss_service(  228): wcnss_read_and_store_cal_data trying to read cal
01-01 13:20:39.794 W/Resources(  201): Preloaded drawable resource #0x10800e5 (android:drawable/btn_check_off_disabled_focused_holo_dark) that varies with configuration!!
01-01 13:20:39.794 E/Diag_Lib(  735): [IMS_FATAL]| 2920 | 768 |ims-rtp-daemon ims_rtp_qmi_handler_thread_func waiting on select thread&gt;
01-01 13:20:39.794 W/Resources(  201): Preloaded drawable resource #0x10800e7 (android:drawable/btn_check_off_disabled_holo_dark) that varies with configuration!!
01-01 13:20:39.794 W/Resources(  201): Preloaded drawable resource #0x10800fc (android:drawable/btn_check_on_disabled_holo_dark) that varies with configuration!!
01-01 13:20:39.794 W/Resources(  201): Preloaded drawable resource #0x10800db (android:drawable/btn_check_holo_dark) that varies with configuration!!
01-01 13:20:39.814 D/dalvikvm(  201): GC_EXPLICIT freed 250K, 12% free 2581K/2904K, paused 1ms+2ms, total 15ms

. . . . . .

01-01 13:20:41.503 I/Zygote  (  201): Accepting command socket connections
01-01 13:20:41.563 D/SensorService( 1095): nuSensorService starting...
01-01 13:20:41.563 I/SystemServer( 1095): Entered the Android system server!
01-01 13:20:41.824 E/Sensors (  429): sns_smr_util.c(104):Unable to initialize service 259 with QCCI, timed out (2000 ms)
01-01 13:20:41.834 E/Sensors (  429): sns_acm_mr.c(469):Error getting info for service 3
01-01 13:20:41.834 E/gsiff_dmn(  226): I/gsiff_dmn_init: Sensor Provider initialized on attempt 0!
01-01 13:20:41.834 E/LocSvc_api_v02(  226): I/locClientOpen:2216]: Service instance id is -1
01-01 13:20:41.834 E/LocSvc_api_v02(  226): I/---&gt; locClientOpenInstance line 2100 loc client open
01-01 13:20:41.834 E/Diag_Lib(  226): Setting internal use port to rmnet0
01-01 13:20:41.873 E/libsensor1( 1095): sensor1_open: Error in connect() errno=14 Bad address
01-01 13:20:41.873 E/sensor_reg( 1095): sensor_reg_sensor1_open: sensor1_open returned 5
01-01 13:20:41.873 E/qcom_sensors_hal( 1095): hal_init: Error in sensor_reg_open(): -1
01-01 13:20:41.873 E/Sensors (  429): sns_main.c(298):Error writing to ctl sock fd 66, err 32
01-01 13:20:41.873 E/LocSvc_api_v02(  226): I/---&gt; locClientSendReq line 2360 QMI_LOC_REG_EVENTS_REQ_V02
01-01 13:20:41.873 E/gsiff_dmn(  226): I/gsiff_loc_api_open: locClientOpen 0 3076981776

. . . . . .

01-01 13:20:42.283 I/ServiceManager(  217): Waiting for service AtCmdFwd...
01-01 13:20:43.284 W/Atfwd_Sendcmd(  217): AtCmdFwd service not published, waiting... retryCnt : 1
01-01 13:20:44.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWiFi-PE] unknown deliver target [OS-Agent]
01-01 13:20:44.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XT-CS] unknown deliver target [OS-Agent]
01-01 13:20:44.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWWAN-PE] unknown deliver target [OS-Agent]
01-01 13:20:48.284 I/ServiceManager(  217): Waiting for service AtCmdFwd...
01-01 13:20:49.284 I/ServiceManager(  217): Waiting for service AtCmdFwd...
01-01 13:20:49.763 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWiFi-PE] unknown deliver target [OS-Agent]
01-01 13:20:49.763 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XT-CS] unknown deliver target [OS-Agent]
01-01 13:20:49.763 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWWAN-PE] unknown deliver target [OS-Agent]
01-01 13:20:50.284 I/ServiceManager(  217): Waiting for service AtCmdFwd...
01-01 13:20:51.284 I/ServiceManager(  217): Waiting for service AtCmdFwd...
01-01 13:20:52.284 I/ServiceManager(  217): Waiting for service AtCmdFwd...
01-01 13:20:53.284 W/Atfwd_Sendcmd(  217): AtCmdFwd service not published, waiting... retryCnt : 2
01-01 13:20:54.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWiFi-PE] unknown deliver target [OS-Agent]
01-01 13:20:54.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XT-CS] unknown deliver target [OS-Agent]
01-01 13:20:54.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWWAN-PE] unknown deliver target [OS-Agent]
01-01 13:20:59.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWiFi-PE] unknown deliver target [OS-Agent]
01-01 13:20:59.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XT-CS] unknown deliver target [OS-Agent]
01-01 13:20:59.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWWAN-PE] unknown deliver target [OS-Agent]
01-01 13:21:03.284 I/ServiceManager(  217): Waiting for service AtCmdFwd...
01-01 13:21:04.284 I/ServiceManager(  217): Waiting for service AtCmdFwd...
01-01 13:21:04.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWiFi-PE] unknown deliver target [OS-Agent]
01-01 13:21:04.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XT-CS] unknown deliver target [OS-Agent]
01-01 13:21:04.764 E/QCALOG  (  372): [MessageQ] ProcessNewMessage: [XTWWAN-PE] unknown deliver target [OS-Agent]
01-01 13:21:05.283 I/ServiceManager(  217): Waiting for service AtCmdFwd...
01-01 13:21:06.284 I/ServiceManager(  217): Waiting for service AtCmdFwd...
</pre>

<p>
从log上看sensor在connect的时候出错了，后面导致了整个QMI等通信有问题，这样导致的结果是有需要和cp通讯的服务就挂掉了，引起死等。
所以就出现了开机开不起来的情况。
</p>

<p>
再从硬件上看，这批板子也是用了当初怀疑有问题的TVS管，所以把sensor上3个TVS管去掉。测试后发现机器好了。
</p>

<p>
最终结论是： TVS管引起了sensor无功能问题，但是前期开机的时候有时会出现QMI消息堵塞导致开机开不起来。
</p>

<p>
&lt;待续&gt;
</p>

</div>
<!-- EDIT3 SECTION "S55/G55 Sensors 相关bug" [973-] -->