
<h1 class="sectionedit1" id="搭建native_service">搭建native service</h1>
<div class="level1">

<p>
Native Service ：又称为 System Service ，是实现在 Runtime 层里的 Server 。搭建Native Service需要注意以下几点：
</p>

&nbsp;&nbsp;（ 1 ）核心服务通常在独立的进程 (Process) 里执行。<BR>

&nbsp;&nbsp;（ 2 ）必须提供 IBinder 接口，让应用程序可以进行跨进程的绑定 (Binding) 和呼叫。<BR>

&nbsp;&nbsp;（ 3 ）因为共享，所以必须确保多线裎安全 (Thread-safe) 。<BR>

&nbsp;&nbsp;（ 4 ）以 C++ 类别定义，诞生其对象，透过 SM 之协助，将该对象参考值传给 IServiceManager::addService() 函数，就加入到 Binder Driver 里了。<BR>

&nbsp;&nbsp;（ 5 ）应用程序可透过 SM 之协助而远距绑定该核心服务，此时 SM 会回传 IBinder 接口给应用程序。<BR>

&nbsp;&nbsp;（ 6 ）应用程序可透过 IBinder::transact() 函数来与核心服务互传数据。 <BR><BR>

<p>
下面通过一个例子来详细描述Native Service的搭建
</p>

</div>
<!-- EDIT1 SECTION "搭建native service" [1-1005] -->
<h3 class="sectionedit2" id="一_接口实现">一、接口实现</h3>
<div class="level3">

&nbsp;&nbsp;在源码external目录下新建目录android-native-service-demo，在该目录下新建client，common，service目录，在common中编写native service接口类<BR>
&nbsp;&nbsp;头文件IDataSourceService.h<BR>
<pre class="code c"><span class="co2">#include &lt;utils/RefBase.h&gt;</span>
<span class="co2">#include &lt;binder/IInterface.h&gt;</span>
<span class="co2">#include &lt;binder/Parcel.h&gt;</span>
<span class="co2">#include &quot;IPluginControler.h&quot;</span>
&nbsp;
using namespace android<span class="sy0">;</span>
using android<span class="sy0">::</span><span class="me2">sp</span><span class="sy0">;</span>
&nbsp;
<span class="kw2">enum</span> <span class="br0">&#123;</span>
    IS_PLUGIN_ENABLE <span class="sy0">=</span> IBinder<span class="sy0">::</span><span class="me2">FIRST_CALL_TRANSACTION</span><span class="sy0">,</span>    <span class="co1">//枚举表示接口类提供的功能</span>
    SET_PLUGIN_ENABLE
<span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
class IDataSourceService <span class="sy0">:</span> public IInterface     <span class="co1">//继承IInterface</span>
<span class="br0">&#123;</span>
public<span class="sy0">:</span>
    DECLARE_META_INTERFACE<span class="br0">&#40;</span>DataSourceService<span class="br0">&#41;</span><span class="sy0">;</span>   <span class="co1">//宏定义，完成IBinder转化成IInterface，与宏IMPLEMENT_META_INTERFACE是一对</span>
&nbsp;
    virtual bool isPluginEnable<span class="br0">&#40;</span><span class="kw4">void</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
    virtual <span class="kw4">void</span> setPluginEnable<span class="br0">&#40;</span>bool enable<span class="br0">&#41;</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
class BnDataSourceService <span class="sy0">:</span> public BnInterface<span class="sy0">&lt;</span>IDataSourceService<span class="sy0">&gt;</span>
<span class="br0">&#123;</span>
    virtual status_t onTransact<span class="br0">&#40;</span><span class="kw4">uint32_t</span> code<span class="sy0">,</span> <span class="kw4">const</span> Parcel<span class="sy0">&amp;</span> data<span class="sy0">,</span> Parcel<span class="sy0">*</span> reply<span class="sy0">,</span> <span class="kw4">uint32_t</span> flags <span class="sy0">=</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span><span class="sy0">;</span></pre>

&nbsp;&nbsp;IDataSourceService.cpp<BR>
<pre class="code c"><span class="co2">#include &quot;IDataSourceService.h&quot;</span>
&nbsp;
using namespace android<span class="sy0">;</span>
&nbsp;
class BpDataSourceService <span class="sy0">:</span> public BpInterface<span class="sy0">&lt;</span>IDataSourceService<span class="sy0">&gt;</span>           <span class="co1">//继承IDataSourceService</span>
<span class="br0">&#123;</span>
public<span class="sy0">:</span>
    BpDataSourceService<span class="br0">&#40;</span><span class="kw4">const</span> sp<span class="sy0">&lt;</span>IBinder<span class="sy0">&gt;&amp;</span> impl<span class="br0">&#41;</span> <span class="sy0">:</span> BpInterface<span class="sy0">&lt;</span>IDataSourceService<span class="sy0">&gt;</span><span class="br0">&#40;</span>impl<span class="br0">&#41;</span><span class="br0">&#123;</span><span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
    bool isPluginEnable<span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        Parcel data<span class="sy0">,</span> reply<span class="sy0">;</span>                                                 <span class="co1">//Parcel类是专门用于binder通信的数据传送，提供了多种类型数据的封装</span>
        data.<span class="me1">writeInterfaceToken</span><span class="br0">&#40;</span>IDataSourceService<span class="sy0">::</span><span class="me2">getInterfaceDescriptor</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>      <span class="co1">//写入接口描述，用于接口验证，避免调用错误</span>
        remote<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span>transact<span class="br0">&#40;</span>IS_PLUGIN_ENABLE<span class="sy0">,</span> data<span class="sy0">,</span> <span class="sy0">&amp;</span>reply<span class="br0">&#41;</span><span class="sy0">;</span>                          <span class="co1">//调用transact函数将data发送给binder，返回数据封装在reply中</span>
        bool ret <span class="sy0">=</span> reply.<span class="me1">readInt32</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">return</span> ret<span class="sy0">;</span>
    <span class="br0">&#125;</span><span class="sy0">;</span>
    <span class="kw4">void</span> setPluginEnable<span class="br0">&#40;</span>bool enable<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;[BpDataSourceService] setPluginEnable<span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        Parcel data<span class="sy0">,</span> reply<span class="sy0">;</span>
        data.<span class="me1">writeInterfaceToken</span><span class="br0">&#40;</span>IDataSourceService<span class="sy0">::</span><span class="me2">getInterfaceDescriptor</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        data.<span class="me1">writeInt32</span><span class="br0">&#40;</span>enable<span class="br0">&#41;</span><span class="sy0">;</span>
        remote<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span>transact<span class="br0">&#40;</span>SET_PLUGIN_ENABLE<span class="sy0">,</span> data<span class="sy0">,</span> <span class="sy0">&amp;</span>reply<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span><span class="sy0">;</span>
<span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
IMPLEMENT_META_INTERFACE<span class="br0">&#40;</span>DataSourceService<span class="sy0">,</span> <span class="st0">&quot;yancy.github.plugin.service&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp;
status_t BnDataSourceService<span class="sy0">::</span><span class="me2">onTransact</span><span class="br0">&#40;</span><span class="kw4">uint32_t</span> code<span class="sy0">,</span> <span class="kw4">const</span> Parcel <span class="sy0">&amp;</span> data<span class="sy0">,</span> Parcel <span class="sy0">*</span> reply<span class="sy0">,</span> <span class="kw4">uint32_t</span> flags<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw1">switch</span><span class="br0">&#40;</span>code<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="kw1">case</span> IS_PLUGIN_ENABLE<span class="sy0">:</span>
        <span class="br0">&#123;</span>
            CHECK_INTERFACE<span class="br0">&#40;</span>IDataSourceService<span class="sy0">,</span> data<span class="sy0">,</span> reply<span class="br0">&#41;</span><span class="sy0">;</span>
            bool ret <span class="sy0">=</span> isPluginEnable<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            reply<span class="sy0">-&gt;</span>writeInt32<span class="br0">&#40;</span>ret<span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">return</span> NO_ERROR<span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">case</span> SET_PLUGIN_ENABLE<span class="sy0">:</span>
        <span class="br0">&#123;</span>
            <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;[BnDataSourceService] onTransact SET_PLUGIN_ENABLE<span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            CHECK_INTERFACE<span class="br0">&#40;</span>IDataSourceService<span class="sy0">,</span> data<span class="sy0">,</span> reply<span class="br0">&#41;</span><span class="sy0">;</span>                         <span class="co1">//Parcel为先进先出存储，数据的写入顺序和读出顺序要一致</span>
            bool enable <span class="sy0">=</span>  data.<span class="me1">readInt32</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            setPluginEnable<span class="br0">&#40;</span>enable<span class="br0">&#41;</span><span class="sy0">;</span>                                                  <span class="co1">//调用真正实现的函数</span>
            <span class="kw1">return</span> NO_ERROR<span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">default</span><span class="sy0">:</span>
            <span class="kw1">return</span> BBinder<span class="sy0">::</span><span class="me2">onTransact</span><span class="br0">&#40;</span>code<span class="sy0">,</span> data<span class="sy0">,</span> reply<span class="sy0">,</span> flags<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>

</div>
<!-- EDIT2 SECTION "一、接口实现" [1006-4309] -->
<h3 class="sectionedit3" id="二_服务实现">二、服务实现</h3>
<div class="level3">

&nbsp;&nbsp;在service目录中编写native service服务实现类<BR>
&nbsp;&nbsp;头文件IDataSourceService.h<BR>
<pre class="code c"><span class="co2">#include &lt;binder/IServiceManager.h&gt;</span>
<span class="co2">#include &lt;binder/IPCThreadState.h&gt;</span>
<span class="co2">#include &lt;IPluginControler.h&gt;</span>
<span class="co2">#include &lt;IDataSourceService.h&gt;</span>
&nbsp;
class DataSourceServiceImpl <span class="sy0">:</span> public BnDataSourceService     <span class="co1">//继承接口类中的BnDataSourceService，具体实现功能</span>
<span class="br0">&#123;</span>
public<span class="sy0">:</span>
    bool isPluginEnable<span class="br0">&#40;</span><span class="kw4">void</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw4">void</span> setPluginEnable<span class="br0">&#40;</span>bool enable<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw4">static</span> <span class="kw4">void</span> instance<span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        defaultServiceManager<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span>addService<span class="br0">&#40;</span>String16<span class="br0">&#40;</span><span class="st0">&quot;DataPluginService&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span> new DataSourceServiceImpl<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//将自身注册到ServiceManager供客户端绑定</span>
    <span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#125;</span><span class="sy0">;</span></pre>

&nbsp;&nbsp;IDataSourceService.cpp<BR>
<pre class="code c"><span class="co2">#define LOG_TAG &quot;DataSourceServiceImpl&quot;</span>
<span class="co2">#include &lt;utils/Log.h&gt;</span>
<span class="co2">#include &quot;DataSourceService.h&quot;</span>
&nbsp;
bool DataSourceServiceImpl<span class="sy0">::</span><span class="me2">isPluginEnable</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceService isPluginEnable <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceService exec isPluginEnable <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">return</span> this<span class="sy0">-&gt;</span>isEnable<span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">void</span> DataSourceServiceImpl<span class="sy0">::</span><span class="me2">setPluginEnable</span><span class="br0">&#40;</span>bool enable<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceService setPluginEnable <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceService exec setPluginEnable <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    mthis<span class="sy0">-&gt;</span>isEnable<span class="sy0">=</span>enable<span class="sy0">;</span>
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceService exec setPluginEnable over <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
&nbsp;
<span class="kw4">int</span> main<span class="br0">&#40;</span><span class="kw4">int</span> argc<span class="sy0">,</span> <span class="kw4">char</span><span class="sy0">**</span> argv<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceService start <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>                   
    DataSourceServiceImpl<span class="sy0">::</span><span class="me2">instance</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>                      
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceService add service <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    ProcessState<span class="sy0">::</span><span class="me2">self</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span>startThreadPool<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>                <span class="co1">//将自身启动</span>
     <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceService startThreadPool ok <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    IPCThreadState<span class="sy0">::</span><span class="me2">self</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span>joinThreadPool<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>               <span class="co1">//将自身加入线程池</span>
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceService end <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>

&nbsp;&nbsp;Android.mk<BR>
<pre class="code c">LOCAL_PATH <span class="sy0">:=</span> $<span class="br0">&#40;</span>call my<span class="sy0">-</span>dir<span class="br0">&#41;</span>
&nbsp;
include $<span class="br0">&#40;</span>CLEAR_VARS<span class="br0">&#41;</span>
&nbsp;
LOCAL_MODULE_TAGS <span class="sy0">:=</span> optional
&nbsp;
LOCAL_SRC_FILES <span class="sy0">:=</span> \
    ..<span class="sy0">/</span>common<span class="sy0">/</span>IDataSourceService.<span class="me1">cpp</span> \                     <span class="co1">//引入写好的接口类</span>
    DataSourceService.<span class="me1">cpp</span>
&nbsp;
LOCAL_C_INCLUDES <span class="sy0">:=</span> \
    external<span class="sy0">/</span>android<span class="sy0">-</span>native<span class="sy0">-</span>service<span class="sy0">-</span>demo<span class="sy0">/</span>common
&nbsp;
LOCAL_SHARED_LIBRARIES<span class="sy0">:=</span> libcutils libutils libbinder      
&nbsp;
LOCAL_MODULE <span class="sy0">:=</span> DataSourceService             
&nbsp;
include $<span class="br0">&#40;</span>BUILD_EXECUTABLE<span class="br0">&#41;</span>        <span class="co1">//生成可执行程序</span></pre>

</div>
<!-- EDIT3 SECTION "二、服务实现" [4310-6637] -->
<h3 class="sectionedit4" id="三_客户端实现">三、客户端实现</h3>
<div class="level3">

&nbsp;&nbsp;在client目录中编写native service客户端实现类<BR>
&nbsp;&nbsp;DataSourceClient.cpp<BR>
<pre class="code c"><span class="co2">#include &lt;binder/IServiceManager.h&gt;</span>
<span class="co2">#include &lt;IDataSourceService.h&gt;</span>
&nbsp;
using namespace android<span class="sy0">;</span>
using android<span class="sy0">::</span><span class="me2">sp</span><span class="sy0">;</span>
&nbsp;
<span class="kw4">int</span> main<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    sp<span class="sy0">&lt;</span>IBinder<span class="sy0">&gt;</span> binder <span class="sy0">=</span> defaultServiceManager<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span>getService<span class="br0">&#40;</span>String16<span class="br0">&#40;</span><span class="st0">&quot;DataPluginService&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>      <span class="co1">//从defaultServiceManager得到服务的binder</span>
    <span class="kw1">if</span><span class="br0">&#40;</span>binder <span class="sy0">==</span> NULL<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;Get service fail media.watermark<span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    sp<span class="sy0">&lt;</span>IDataSourceService<span class="sy0">&gt;</span> service <span class="sy0">=</span> IDataSourceService<span class="sy0">::</span><span class="me2">asInterface</span><span class="br0">&#40;</span>binder<span class="br0">&#41;</span><span class="sy0">;</span>                   <span class="co1">//将服务binder转化为接口类</span>
    <span class="kw1">if</span><span class="br0">&#40;</span>service <span class="sy0">==</span> NULL<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;connect service fail media.watermark<span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw4">int</span> input <span class="sy0">=</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span>
    <span class="kw4">int</span> result<span class="sy0">=</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span>
    <span class="kw1">while</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;[1]Enable plugin; [2]Disable plugin; [3]Quit: &quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <a href="http://www.opengroup.org/onlinepubs/009695399/functions/scanf.html"><span class="kw3">scanf</span></a><span class="br0">&#40;</span><span class="st0">&quot;%d&quot;</span><span class="sy0">,</span> <span class="sy0">&amp;</span>input<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">switch</span><span class="br0">&#40;</span>input<span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            <span class="kw1">case</span> <span class="nu0">1</span><span class="sy0">:</span>
                <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceClient enable plugin<span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>                                      <span class="co1">//客户端直接调用接口函数</span>
                service<span class="sy0">-&gt;</span>setPluginEnable<span class="br0">&#40;</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw2">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> <span class="nu0">2</span><span class="sy0">:</span>
                <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceClient disable plugin<span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                service<span class="sy0">-&gt;</span>setPluginEnable<span class="br0">&#40;</span><span class="kw2">false</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw2">break</span><span class="sy0">;</span>
           <span class="kw1">case</span> <span class="nu0">3</span><span class="sy0">:</span>
                <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceClient isPluginEnable<span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                service<span class="sy0">-&gt;</span>isPluginEnable<span class="br0">&#40;</span><span class="sy0">&amp;</span>result<span class="br0">&#41;</span><span class="sy0">;</span>
                <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceClient isPluginEnable %d<span class="es1">\n</span>&quot;</span><span class="sy0">,</span>result<span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw2">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> <span class="nu0">4</span><span class="sy0">:</span>
                <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;DataSourceClient exit <span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">goto</span> Exit<span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span> <span class="co1">// while</span>
&nbsp;
Exit<span class="sy0">:</span>
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;Client exit...<span class="es1">\n</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>

&nbsp;&nbsp;Android.mk<BR>
<pre class="code c">LOCAL_PATH <span class="sy0">:=</span> $<span class="br0">&#40;</span>call my<span class="sy0">-</span>dir<span class="br0">&#41;</span>
&nbsp;
include $<span class="br0">&#40;</span>CLEAR_VARS<span class="br0">&#41;</span>
&nbsp;
LOCAL_MODULE_TAGS <span class="sy0">:=</span> optional
&nbsp;
<span class="co2">#引入接口类</span>
LOCAL_SRC_FILES <span class="sy0">:=</span> \
    ..<span class="sy0">/</span>common<span class="sy0">/</span>IDataSourceService.<span class="me1">cpp</span> \
    DataSourceClient.<span class="me1">cpp</span>
&nbsp;
LOCAL_C_INCLUDES <span class="sy0">:=</span> \
    external<span class="sy0">/</span>android<span class="sy0">-</span>native<span class="sy0">-</span>service<span class="sy0">-</span>demo<span class="sy0">/</span>common
&nbsp;
LOCAL_SHARED_LIBRARIES<span class="sy0">:=</span> libcutils libutils libbinder
&nbsp;
LOCAL_MODULE <span class="sy0">:=</span> DataSourceClient
&nbsp;
include $<span class="br0">&#40;</span>BUILD_EXECUTABLE<span class="br0">&#41;</span>                        <span class="co2">#生成可执行程序</span></pre>

</div>
<!-- EDIT4 SECTION "三、客户端实现" [6638-8885] -->
<h3 class="sectionedit5" id="四_将native_service添加为开机启动项">四、将native service添加为开机启动项</h3>
<div class="level3">

&nbsp;&nbsp;1.修改init.rc,添加service<BR>
<pre class="code c">service DataSourceService <span class="sy0">/</span><a href="http://www.opengroup.org/onlinepubs/009695399/functions/system.html"><span class="kw3">system</span></a><span class="sy0">/</span>bin<span class="sy0">/</span>DataSourceService
    class main</pre>

&nbsp;&nbsp;2.添加linux安全策略，方法请参考<a href="http://172.21.1.23/dokuwiki/doku.php/android;sepolicy%E8%A7%84%E5%88%99">添加linux策略</a><BR>

</div>
<!-- EDIT5 SECTION "四、将native service添加为开机启动项" [8886-] -->