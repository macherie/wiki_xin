
<h1 class="sectionedit1" id="双摄像头后台录制方案">双摄像头后台录制方案</h1>
<div class="level1">

<p>
研发平台：MT6735
</p>

</div>
<!-- EDIT1 SECTION "双摄像头后台录制方案" [1-68] -->
<h3 class="sectionedit2" id="一_主要遇到的问题">一、主要遇到的问题</h3>
<div class="level3">

1.1&nbsp;&nbsp;前期的录像编码采用过的API 包括：MediaCodec、MediaExtractor、MediaMuxer、MediaFormat这部分需要开发者非常熟悉这套API，不然开发、维护起来比较耗时。所以我使用的是MediaRecorder封装好的接口进行编码，但是MediaRecorder默认不支持两个摄像头录像编码，需要打开限制。(PS：MediaCodec、MediaExtractor这块API使用可参考<a href="http://172.21.1.23/dokuwiki/doku.php/android;application;%E4%B8%8D%E4%B8%A2%E7%A7%92%E5%88%86%E6%AE%B5%E5%BD%95%E5%83%8F%E6%96%B9%E6%A1%88">不漏秒分段录像方案</a>)<br><BR>

1.2&nbsp;&nbsp;在显示上曾用过SurfaceView来进行过预览，需要支持后台录像功能的话不能使用它，因为每次Activity退到后台时会不可控执行surfaceDestroyed销毁控件，再进入Activity的时候就会再次创建SurfaceView。在使用上SurfaceView控件必须与Camera绑定，直接影响了数据获取、文件编码，所以不能使用这种方式预览。后来我们采用GLSurfaceView来解决此问题，GLSurfaceView是SurfaceView的子类，在功能上进行了强大的扩展，绑定纹理ID号之后采用OpenGL的一些渲染函数进行画面绘制。避开了SurfaceView的销毁重新创建问题。<BR><BR>

</div>
<!-- EDIT2 SECTION "一、主要遇到的问题" [69-1394] -->
<h3 class="sectionedit3" id="二_目前的方案流程">二、目前的方案流程</h3>
<div class="level3">

2.1&nbsp;&nbsp;Camera负责open摄像头。GLSurfaceView创建纹理ID传递给SurfaceTexture然后与Camera进行绑定。<BR>
2.2&nbsp;&nbsp;GLSurfaceView负责录像时画面渲染<BR>
2.3&nbsp;&nbsp;MediaRecorder负责Camera捕获的数据进行编码，封装成媒体文件。<BR>
2.4&nbsp;&nbsp;Service负责后台运行时的进程保持。<BR><BR>

</div>
<!-- EDIT3 SECTION "二、目前的方案流程" [1395-1805] -->
<h3 class="sectionedit4" id="三_关键代码">三、关键代码</h3>
<div class="level3">

3.1&nbsp;&nbsp;解除MTK对MediaRecorder双摄像头编码限制。<BR>
修改路径：vendor/mediatek/proprietary/platform/mt6735/hardware/mtkcam/D1/hwutils/CamManager.cpp
<pre class="code C">getPermission<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw4">const</span>
<span class="br0">&#123;</span>
    Mutex<span class="sy0">::</span><span class="me2">Autolock</span> _l<span class="br0">&#40;</span>mLockMtx<span class="br0">&#41;</span><span class="sy0">;</span>
    MY_LOGD<span class="br0">&#40;</span><span class="st0">&quot;mDeviceCnt(%d), mbRecord(%d), mbAvailable(%d), mbStereo(%d), 0:fps(%d); 1:fps(%d)&quot;</span><span class="sy0">,</span>
            mDeviceCnt<span class="sy0">,</span> mbRecord<span class="sy0">,</span> mbAvailable<span class="sy0">,</span> mbStereo<span class="sy0">,</span> getFrameRate<span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">,</span> getFrameRate<span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="co1">//return !mbRecord &amp;&amp; mbAvailable &amp;&amp; !mbStereo;</span>
    <span class="kw1">return</span> mbAvailable <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span>mbStereo<span class="sy0">;</span>
<span class="br0">&#125;</span></pre>

3.2&nbsp;&nbsp;使用Camera打开摄像头以及绑定SurfaceTexture，从图像流中捕获帧作为OpenGL纹理，Camera的预览数据，变成纹理后可以交给GLSurfaceView直接显示。<BR>
<pre class="code java"><span class="kw1">public</span> <span class="kw4">void</span> startCameraPreview<span class="br0">&#40;</span>SurfaceTexture st<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">try</span> <span class="br0">&#123;</span>
        mCamera <span class="sy0">=</span> Camera.<span class="me1">open</span><span class="br0">&#40;</span>mCameraId<span class="br0">&#41;</span><span class="sy0">;</span>
        Parameters parameters <span class="sy0">=</span> mCamera.<span class="me1">getParameters</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        parameters.<span class="me1">setPreviewSize</span><span class="br0">&#40;</span>mVideoWidth, mVideoHeight<span class="br0">&#41;</span><span class="sy0">;</span>
        mCamera.<span class="me1">setParameters</span><span class="br0">&#40;</span>parameters<span class="br0">&#41;</span><span class="sy0">;</span>
        mCamera.<span class="me1">setPreviewTexture</span><span class="br0">&#40;</span>st<span class="br0">&#41;</span><span class="sy0">;</span>
        mCamera.<span class="me1">startPreview</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">catch</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+ioexception"><span class="kw3">IOException</span></a> e<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        e.<span class="me1">printStackTrace</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>

3.3&nbsp;&nbsp;CameraGLSurfaceView.java实现<BR>
<pre class="code java"><span class="kw1">public</span> <span class="kw1">class</span> CameraGLSurfaceView <span class="kw1">extends</span> GLSurfaceView <span class="kw1">implements</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+renderer"><span class="kw3">Renderer</span></a>,
        SurfaceTexture.<span class="me1">OnFrameAvailableListener</span> <span class="br0">&#123;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw1">static</span> <span class="kw1">final</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> TAG <span class="sy0">=</span> <span class="st0">&quot;CameraGLSurfaceView&quot;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> SurfaceTexture mSurface<span class="sy0">;</span>
    <span class="kw1">private</span> <span class="kw4">int</span> mTextureID <span class="sy0">=</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span>
    <span class="kw1">private</span> DirectDrawer mDirectDrawer<span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> CameraProxy mProxyFront, mProxyBack<span class="sy0">;</span>
&nbsp;
    <span class="kw1">public</span> CameraGLSurfaceView<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a> ctx, CameraProxy proxy, <span class="kw4">int</span> cameraId<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">super</span><span class="br0">&#40;</span>ctx<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        setEGLContextClientVersion<span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span>
        setRenderer<span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span>
        setRenderMode<span class="br0">&#40;</span>RENDERMODE_WHEN_DIRTY<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 脏模式，意思就是有数据的时候才进入onDrawFrame进行渲染</span>
&nbsp;
        <span class="kw1">if</span> <span class="br0">&#40;</span>proxy <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>cameraId <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                mSurface <span class="sy0">=</span> proxy.<span class="me1">getSurfaceTexureFront</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                mTextureID <span class="sy0">=</span> proxy.<span class="me1">getTexureIdFront</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                proxy.<span class="me1">registerFrameAvailableListenerFront</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span>
                mProxyFront <span class="sy0">=</span> proxy<span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>cameraId <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                mSurface <span class="sy0">=</span> proxy.<span class="me1">getSurfaceTexureBack</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                mTextureID <span class="sy0">=</span> proxy.<span class="me1">getTexureIdBack</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                proxy.<span class="me1">registerFrameAvailableListenerBack</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span>
                mProxyBack <span class="sy0">=</span> proxy<span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
&nbsp;
    <span class="br0">&#125;</span>
&nbsp;
    <span class="co3">/** 创建纹理ID **/</span>
    <span class="kw1">public</span> <span class="kw1">static</span> <span class="kw4">int</span> createTextureID<span class="br0">&#40;</span><span class="kw4">int</span> cameraId<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw4">int</span><span class="br0">&#91;</span><span class="br0">&#93;</span> texture <span class="sy0">=</span> <span class="kw1">new</span> <span class="kw4">int</span><span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span><span class="sy0">;</span>
        texture<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span><span class="co1">// 后摄</span>
        texture<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span><span class="co1">// 前摄</span>
&nbsp;
        GLES20.<span class="me1">glGenTextures</span><span class="br0">&#40;</span><span class="nu0">1</span>, texture, <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glBindTexture</span><span class="br0">&#40;</span>GLES11Ext.<span class="me1">GL_TEXTURE_EXTERNAL_OES</span>, texture<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glTexParameterf</span><span class="br0">&#40;</span>GLES11Ext.<span class="me1">GL_TEXTURE_EXTERNAL_OES</span>,
                GL10.<span class="me1">GL_TEXTURE_MIN_FILTER</span>, GL10.<span class="me1">GL_LINEAR</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glTexParameterf</span><span class="br0">&#40;</span>GLES11Ext.<span class="me1">GL_TEXTURE_EXTERNAL_OES</span>,
                GL10.<span class="me1">GL_TEXTURE_MAG_FILTER</span>, GL10.<span class="me1">GL_LINEAR</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glTexParameteri</span><span class="br0">&#40;</span>GLES11Ext.<span class="me1">GL_TEXTURE_EXTERNAL_OES</span>,
                GL10.<span class="me1">GL_TEXTURE_WRAP_S</span>, GL10.<span class="me1">GL_CLAMP_TO_EDGE</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glTexParameteri</span><span class="br0">&#40;</span>GLES11Ext.<span class="me1">GL_TEXTURE_EXTERNAL_OES</span>,
                GL10.<span class="me1">GL_TEXTURE_WRAP_T</span>, GL10.<span class="me1">GL_CLAMP_TO_EDGE</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>cameraId <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span>
            <span class="kw1">return</span> texture<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span>
        <span class="kw1">else</span>
            <span class="kw1">return</span> texture<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onSurfaceCreated<span class="br0">&#40;</span>GL10 gl, EGLConfig config<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Log.<span class="me1">i</span><span class="br0">&#40;</span>TAG, <span class="st0">&quot;onSurfaceCreated...&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mDirectDrawer <span class="sy0">=</span> <span class="kw1">new</span> DirectDrawer<span class="br0">&#40;</span>mTextureID<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 当创建时把纹理ID下发给渲染封装类</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onSurfaceChanged<span class="br0">&#40;</span>GL10 gl, <span class="kw4">int</span> width, <span class="kw4">int</span> height<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Log.<span class="me1">i</span><span class="br0">&#40;</span>TAG, <span class="st0">&quot;onSurfaceChanged...&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glViewport</span><span class="br0">&#40;</span><span class="nu0">0</span>, <span class="nu0">0</span>, width, height<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onDrawFrame<span class="br0">&#40;</span>GL10 gl<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Log.<span class="me1">i</span><span class="br0">&#40;</span>TAG, <span class="st0">&quot;onDrawFrame...&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1">// 获取手机屏幕尺寸并计算出一半尺寸-两个画面分割线高度</span>
        DisplayMetrics dm <span class="sy0">=</span> MainActivity.<span class="me1">getDisplayMetrics</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glViewport</span><span class="br0">&#40;</span><span class="nu0">0</span>, <span class="nu0">0</span>, dm.<span class="me1">widthPixels</span>, dm.<span class="me1">heightPixels</span> <span class="sy0">/</span> <span class="nu0">2</span> <span class="sy0">-</span> <span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glClearColor</span><span class="br0">&#40;</span>1.0f, 1.0f, 1.0f, 1.0f<span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glClear</span><span class="br0">&#40;</span>GLES20.<span class="me1">GL_COLOR_BUFFER_BIT</span> <span class="sy0">|</span> GLES20.<span class="me1">GL_DEPTH_BUFFER_BIT</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">try</span> <span class="br0">&#123;</span>
            mSurface.<span class="me1">updateTexImage</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">catch</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+exception"><span class="kw3">Exception</span></a> e<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="kw4">float</span><span class="br0">&#91;</span><span class="br0">&#93;</span> mtx <span class="sy0">=</span> <span class="kw1">new</span> <span class="kw4">float</span><span class="br0">&#91;</span><span class="nu0">16</span><span class="br0">&#93;</span><span class="sy0">;</span>
        mSurface.<span class="me1">getTransformMatrix</span><span class="br0">&#40;</span>mtx<span class="br0">&#41;</span><span class="sy0">;</span>
        mDirectDrawer.<span class="me1">draw</span><span class="br0">&#40;</span>mtx<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 主要在此进行渲染</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onFrameAvailable<span class="br0">&#40;</span>SurfaceTexture surfaceTexture<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Log.<span class="me1">i</span><span class="br0">&#40;</span>TAG, <span class="st0">&quot;onFrameAvailable...&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">requestRender</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">protected</span> <span class="kw4">void</span> onDetachedFromWindow<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Log.<span class="me1">d</span><span class="br0">&#40;</span>TAG, <span class="st0">&quot;onDetachedFromWindow&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw2">null</span> <span class="sy0">!=</span> mProxyFront<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mProxyFront.<span class="me1">registerFrameAvailableListenerFront</span><span class="br0">&#40;</span><span class="kw2">null</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw2">null</span> <span class="sy0">!=</span> mProxyBack<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mProxyBack.<span class="me1">registerFrameAvailableListenerBack</span><span class="br0">&#40;</span><span class="kw2">null</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">super</span>.<span class="me1">onDetachedFromWindow</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onPause<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Log.<span class="me1">d</span><span class="br0">&#40;</span>TAG, <span class="st0">&quot;onPause&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">super</span>.<span class="me1">onPause</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onResume<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Log.<span class="me1">d</span><span class="br0">&#40;</span>TAG, <span class="st0">&quot;onResume&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">super</span>.<span class="me1">onResume</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#125;</span></pre>

3.4&nbsp;&nbsp;DirectDrawer.java渲染封装类<BR>
<pre class="code java"><span class="kw1">public</span> <span class="kw1">class</span> DirectDrawer <span class="br0">&#123;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw1">final</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> vertexShaderCode <span class="sy0">=</span>
            <span class="st0">&quot;attribute vec4 vPosition;&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;attribute vec2 inputTextureCoordinate;&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;varying vec2 textureCoordinate;&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;void main()&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;{&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;gl_Position = vPosition;&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;textureCoordinate = inputTextureCoordinate;&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;}&quot;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw1">final</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> fragmentShaderCode <span class="sy0">=</span>
            <span class="st0">&quot;#extension GL_OES_EGL_image_external : require<span class="es0">\n</span>&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;precision mediump float;&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;varying vec2 textureCoordinate;<span class="es0">\n</span>&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;uniform samplerExternalOES s_texture;<span class="es0">\n</span>&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;void main() {&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;  gl_FragColor = texture2D( s_texture, textureCoordinate );<span class="es0">\n</span>&quot;</span> <span class="sy0">+</span>
                    <span class="st0">&quot;}&quot;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> FloatBuffer vertexBuffer, textureVerticesBuffer<span class="sy0">;</span>
    <span class="kw1">private</span> ShortBuffer drawListBuffer<span class="sy0">;</span>
    <span class="kw1">private</span> <span class="kw1">final</span> <span class="kw4">int</span> mProgram<span class="sy0">;</span>
    <span class="kw1">private</span> <span class="kw4">int</span> mPositionHandle<span class="sy0">;</span>
    <span class="kw1">private</span> <span class="kw4">int</span> mTextureCoordHandle<span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw4">short</span> drawOrder<span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#123;</span>
            <span class="nu0">0</span>, <span class="nu0">1</span>, <span class="nu0">2</span>, <span class="nu0">0</span>, <span class="nu0">2</span>, <span class="nu0">3</span>
    <span class="br0">&#125;</span><span class="sy0">;</span> <span class="co1">// order to draw vertices</span>
&nbsp;
    <span class="co1">// number of coordinates per vertex in this array</span>
    <span class="kw1">private</span> <span class="kw1">static</span> <span class="kw1">final</span> <span class="kw4">int</span> COORDS_PER_VERTEX <span class="sy0">=</span> <span class="nu0">2</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw1">final</span> <span class="kw4">int</span> vertexStride <span class="sy0">=</span> COORDS_PER_VERTEX <span class="sy0">*</span> <span class="nu0">4</span><span class="sy0">;</span> <span class="co1">// 4 bytes per vertex</span>
&nbsp;
    <span class="kw1">static</span> <span class="kw4">float</span> squareCoords<span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#123;</span>
            <span class="sy0">-</span>1.0f, 1.0f,
            <span class="sy0">-</span>1.0f, <span class="sy0">-</span>1.0f,
            1.0f, <span class="sy0">-</span>1.0f,
            1.0f, 1.0f,
    <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">static</span> <span class="kw4">float</span> textureVertices<span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#123;</span>
            0.0f, 1.0f,
            1.0f, 1.0f,
            1.0f, 0.0f,
            0.0f, 0.0f,
    <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw4">int</span> texture<span class="sy0">;</span>
&nbsp;
    <span class="kw1">public</span> DirectDrawer<span class="br0">&#40;</span><span class="kw4">int</span> texture<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="kw1">this</span>.<span class="me1">texture</span> <span class="sy0">=</span> texture<span class="sy0">;</span>
        <span class="co1">// initialize vertex byte buffer for shape coordinates</span>
        ByteBuffer bb <span class="sy0">=</span> ByteBuffer.<span class="me1">allocateDirect</span><span class="br0">&#40;</span>squareCoords.<span class="me1">length</span> <span class="sy0">*</span> <span class="nu0">4</span><span class="br0">&#41;</span><span class="sy0">;</span>
        bb.<span class="me1">order</span><span class="br0">&#40;</span>ByteOrder.<span class="me1">nativeOrder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        vertexBuffer <span class="sy0">=</span> bb.<span class="me1">asFloatBuffer</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        vertexBuffer.<span class="me1">put</span><span class="br0">&#40;</span>squareCoords<span class="br0">&#41;</span><span class="sy0">;</span>
        vertexBuffer.<span class="me1">position</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// initialize byte buffer for the draw list</span>
        ByteBuffer dlb <span class="sy0">=</span> ByteBuffer.<span class="me1">allocateDirect</span><span class="br0">&#40;</span>drawOrder.<span class="me1">length</span> <span class="sy0">*</span> <span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span>
        dlb.<span class="me1">order</span><span class="br0">&#40;</span>ByteOrder.<span class="me1">nativeOrder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        drawListBuffer <span class="sy0">=</span> dlb.<span class="me1">asShortBuffer</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        drawListBuffer.<span class="me1">put</span><span class="br0">&#40;</span>drawOrder<span class="br0">&#41;</span><span class="sy0">;</span>
        drawListBuffer.<span class="me1">position</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        ByteBuffer bb2 <span class="sy0">=</span> ByteBuffer.<span class="me1">allocateDirect</span><span class="br0">&#40;</span>textureVertices.<span class="me1">length</span> <span class="sy0">*</span> <span class="nu0">4</span><span class="br0">&#41;</span><span class="sy0">;</span>
        bb2.<span class="me1">order</span><span class="br0">&#40;</span>ByteOrder.<span class="me1">nativeOrder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        textureVerticesBuffer <span class="sy0">=</span> bb2.<span class="me1">asFloatBuffer</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        textureVerticesBuffer.<span class="me1">put</span><span class="br0">&#40;</span>textureVertices<span class="br0">&#41;</span><span class="sy0">;</span>
        textureVerticesBuffer.<span class="me1">position</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="kw4">int</span> vertexShader <span class="sy0">=</span> loadShader<span class="br0">&#40;</span>GLES20.<span class="me1">GL_VERTEX_SHADER</span>, vertexShaderCode<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw4">int</span> fragmentShader <span class="sy0">=</span> loadShader<span class="br0">&#40;</span>GLES20.<span class="me1">GL_FRAGMENT_SHADER</span>, fragmentShaderCode<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        mProgram <span class="sy0">=</span> GLES20.<span class="me1">glCreateProgram</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// create empty OpenGL ES Program</span>
        GLES20.<span class="me1">glAttachShader</span><span class="br0">&#40;</span>mProgram, vertexShader<span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// add the vertex shader to program</span>
        GLES20.<span class="me1">glAttachShader</span><span class="br0">&#40;</span>mProgram, fragmentShader<span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// add the fragment shader to program</span>
        GLES20.<span class="me1">glLinkProgram</span><span class="br0">&#40;</span>mProgram<span class="br0">&#41;</span><span class="sy0">;</span> <span class="co1">// creates OpenGL ES program executables</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">public</span> <span class="kw4">void</span> draw<span class="br0">&#40;</span><span class="kw4">float</span><span class="br0">&#91;</span><span class="br0">&#93;</span> mtx<span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        GLES20.<span class="me1">glUseProgram</span><span class="br0">&#40;</span>mProgram<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        GLES20.<span class="me1">glActiveTexture</span><span class="br0">&#40;</span>GLES20.<span class="me1">GL_TEXTURE0</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glBindTexture</span><span class="br0">&#40;</span>GLES11Ext.<span class="me1">GL_TEXTURE_EXTERNAL_OES</span>, texture<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// get handle to vertex shader's vPosition member</span>
        mPositionHandle <span class="sy0">=</span> GLES20.<span class="me1">glGetAttribLocation</span><span class="br0">&#40;</span>mProgram, <span class="st0">&quot;vPosition&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Enable a handle to the triangle vertices</span>
        GLES20.<span class="me1">glEnableVertexAttribArray</span><span class="br0">&#40;</span>mPositionHandle<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Prepare the &lt;insert shape here&gt; coordinate data</span>
        GLES20.<span class="me1">glVertexAttribPointer</span><span class="br0">&#40;</span>mPositionHandle, COORDS_PER_VERTEX, GLES20.<span class="me1">GL_FLOAT</span>, <span class="kw2">false</span>,
                vertexStride, vertexBuffer<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        mTextureCoordHandle <span class="sy0">=</span> GLES20.<span class="me1">glGetAttribLocation</span><span class="br0">&#40;</span>mProgram, <span class="st0">&quot;inputTextureCoordinate&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glEnableVertexAttribArray</span><span class="br0">&#40;</span>mTextureCoordHandle<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        GLES20.<span class="me1">glVertexAttribPointer</span><span class="br0">&#40;</span>mTextureCoordHandle, COORDS_PER_VERTEX, GLES20.<span class="me1">GL_FLOAT</span>,
                <span class="kw2">false</span>, vertexStride, textureVerticesBuffer<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        GLES20.<span class="me1">glDrawElements</span><span class="br0">&#40;</span>GLES20.<span class="me1">GL_TRIANGLES</span>, drawOrder.<span class="me1">length</span>, GLES20.<span class="me1">GL_UNSIGNED_SHORT</span>,
                drawListBuffer<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Disable vertex array</span>
        GLES20.<span class="me1">glDisableVertexAttribArray</span><span class="br0">&#40;</span>mPositionHandle<span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glDisableVertexAttribArray</span><span class="br0">&#40;</span>mTextureCoordHandle<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw4">int</span> loadShader<span class="br0">&#40;</span><span class="kw4">int</span> type, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> shaderCode<span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
        <span class="co1">// create a vertex shader type (GLES20.GL_VERTEX_SHADER)</span>
        <span class="co1">// or a fragment shader type (GLES20.GL_FRAGMENT_SHADER)</span>
        <span class="kw4">int</span> shader <span class="sy0">=</span> GLES20.<span class="me1">glCreateShader</span><span class="br0">&#40;</span>type<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// add the source code to the shader and compile it</span>
        GLES20.<span class="me1">glShaderSource</span><span class="br0">&#40;</span>shader, shaderCode<span class="br0">&#41;</span><span class="sy0">;</span>
        GLES20.<span class="me1">glCompileShader</span><span class="br0">&#40;</span>shader<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">return</span> shader<span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>

3.5&nbsp;&nbsp;实例化MediaRecorder编码器<BR>
<pre class="code java"><span class="kw1">public</span> <span class="kw4">void</span> startMediaRecorder<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">try</span> <span class="br0">&#123;</span>
        mMr <span class="sy0">=</span> <span class="kw1">new</span> MediaRecorder<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mCamera.<span class="me1">unlock</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mMr.<span class="me1">setCamera</span><span class="br0">&#40;</span>mCamera<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 设置Camera进行绑定将摄像头数据进行编码，视频文件封装</span>
        mMr.<span class="me1">setVideoSource</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">VideoSource</span>.<span class="me1">CAMERA</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 视频来源</span>
        mMr.<span class="me1">setAudioSource</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">AudioSource</span>.<span class="me1">CAMCORDER</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 音频来源</span>
        mMr.<span class="me1">setOutputFormat</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">OutputFormat</span>.<span class="me1">MPEG_4</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 视频格式</span>
        mMr.<span class="me1">setAudioEncoder</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">AudioEncoder</span>.<span class="me1">AAC</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 音频编码</span>
        mMr.<span class="me1">setVideoEncoder</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">VideoEncoder</span>.<span class="me1">H264</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 视频硬编码</span>
        mMr.<span class="me1">setVideoSize</span><span class="br0">&#40;</span>mVideoWidth, mVideoHeight<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 视频高宽</span>
        mMr.<span class="me1">setVideoFrameRate</span><span class="br0">&#40;</span>RECODER_FRAMERATE<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 帧率</span>
        mMr.<span class="me1">setVideoEncodingBitRate</span><span class="br0">&#40;</span>RECODER_BITRATE<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 比特率，码率</span>
        mMr.<span class="me1">setOutputFile</span><span class="br0">&#40;</span>mVideoFilename<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 文件输出位置</span>
        mMr.<span class="me1">prepare</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mMr.<span class="me1">start</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span> <span class="kw1">catch</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+exception"><span class="kw3">Exception</span></a> e<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        e.<span class="me1">printStackTrace</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>

3.6&nbsp;&nbsp;Service来负责创建Camera、MediaRecorder，并且负责持久进程。<BR>
<pre class="code java"><span class="kw1">public</span> <span class="kw1">class</span> CameraService <span class="kw1">extends</span> Service <span class="br0">&#123;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw1">static</span> <span class="kw1">final</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> TAG <span class="sy0">=</span> <span class="st0">&quot;SimCameraService&quot;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw4">int</span> mTexureIdFront, mTexureIdBack<span class="sy0">;</span>
    <span class="kw1">private</span> SurfaceTexture mSurfaceTextureFront, mSurfaceTextureBack<span class="sy0">;</span>
    <span class="kw1">private</span> SegmentedUtil mSegmentedFront, mSegmentedBack<span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> OnFrameAvailableListener mViewListenerFront <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
    <span class="kw1">private</span> OnFrameAvailableListener mViewListenerBack <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> CameraBinder mBinder <span class="sy0">=</span> <span class="kw1">new</span> CameraBinder<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> IBinder onBind<span class="br0">&#40;</span>Intent intent<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> mBinder<span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onCreate<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">super</span>.<span class="me1">onCreate</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        startForeground<span class="br0">&#40;</span><span class="sy0">-</span><span class="nu0">1982</span>, <span class="kw1">new</span> Notification<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">// 此处用意将Service暴露为可视化进程，提高优先级，防止被杀死</span>
&nbsp;
        <span class="co1">// 启动前摄</span>
        mTexureIdFront <span class="sy0">=</span> CameraGLSurfaceView.<span class="me1">createTextureID</span><span class="br0">&#40;</span>SegmentedBase.<span class="me1">CAMERA_ID_FRONT</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mSurfaceTextureFront <span class="sy0">=</span> <span class="kw1">new</span> SurfaceTexture<span class="br0">&#40;</span>mTexureIdFront<span class="br0">&#41;</span><span class="sy0">;</span>
        mSurfaceTextureFront.<span class="me1">setOnFrameAvailableListener</span><span class="br0">&#40;</span>mInternalListenerFront<span class="br0">&#41;</span><span class="sy0">;</span>
        mSegmentedFront <span class="sy0">=</span> <span class="kw1">new</span> SegmentedUtil<span class="br0">&#40;</span>SegmentedBase.<span class="me1">CAMERA_ID_FRONT</span>,
                SegmentedBase.<span class="me1">VIDEO_WIDTH_FRONT</span>,
                SegmentedBase.<span class="me1">VIDEO_HEIGHT_FRONT</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mSegmentedFront.<span class="me1">startCameraPreview</span><span class="br0">&#40;</span>mSurfaceTextureFront<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// 启动后摄</span>
        mTexureIdBack <span class="sy0">=</span> CameraGLSurfaceView.<span class="me1">createTextureID</span><span class="br0">&#40;</span>SegmentedBase.<span class="me1">CAMERA_ID_BACK</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mSurfaceTextureBack <span class="sy0">=</span> <span class="kw1">new</span> SurfaceTexture<span class="br0">&#40;</span>mTexureIdBack<span class="br0">&#41;</span><span class="sy0">;</span>
        mSurfaceTextureBack.<span class="me1">setOnFrameAvailableListener</span><span class="br0">&#40;</span>mInternalListenerBack<span class="br0">&#41;</span><span class="sy0">;</span>
        mSegmentedBack <span class="sy0">=</span> <span class="kw1">new</span> SegmentedUtil<span class="br0">&#40;</span>SegmentedBase.<span class="me1">CAMERA_ID_BACK</span>,
                SegmentedBase.<span class="me1">VIDEO_WIDTH_BACK</span>,
                SegmentedBase.<span class="me1">VIDEO_HEIGHT_BACK</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mSegmentedBack.<span class="me1">startCameraPreview</span><span class="br0">&#40;</span>mSurfaceTextureBack<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// 通知MainActivity绑定服务</span>
        sendStickyBroadcast<span class="br0">&#40;</span><span class="kw1">new</span> Intent<span class="br0">&#40;</span>CameraProxy.<span class="me1">ACTION_SERVICE_CREATED</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="co3">/** MainActivity与CameraService通信Binder **/</span>
    <span class="kw1">public</span> <span class="kw1">class</span> CameraBinder <span class="kw1">extends</span> Binder <span class="kw1">implements</span> CameraProxy <span class="br0">&#123;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> SurfaceTexture getSurfaceTexureFront<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">return</span> mSurfaceTextureFront<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">int</span> getTexureIdFront<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">return</span> mTexureIdFront<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">void</span> registerFrameAvailableListenerFront<span class="br0">&#40;</span>OnFrameAvailableListener l<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mViewListenerFront <span class="sy0">=</span> l<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> SurfaceTexture getSurfaceTexureBack<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">return</span> mSurfaceTextureBack<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">int</span> getTexureIdBack<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">return</span> mTexureIdBack<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">void</span> registerFrameAvailableListenerBack<span class="br0">&#40;</span>OnFrameAvailableListener l<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mViewListenerBack <span class="sy0">=</span> l<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">void</span> startMediaRecorder<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            startMedia<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">void</span> stopMediaRecorder<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            stopMedia<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
    <span class="br0">&#125;</span>
&nbsp;
    <span class="co3">/** 前摄画面绘制监听 **/</span>
    <span class="kw1">private</span> OnFrameAvailableListener mInternalListenerFront <span class="sy0">=</span> <span class="kw1">new</span> OnFrameAvailableListener<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">void</span> onFrameAvailable<span class="br0">&#40;</span>SurfaceTexture surfaceTexture<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>mViewListenerFront <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                mViewListenerFront.<span class="me1">onFrameAvailable</span><span class="br0">&#40;</span>surfaceTexture<span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
&nbsp;
    <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
    <span class="co3">/** 后摄画面绘制监听 **/</span>
    <span class="kw1">private</span> OnFrameAvailableListener mInternalListenerBack <span class="sy0">=</span> <span class="kw1">new</span> OnFrameAvailableListener<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">void</span> onFrameAvailable<span class="br0">&#40;</span>SurfaceTexture surfaceTexture<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>mViewListenerBack <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                mViewListenerBack.<span class="me1">onFrameAvailable</span><span class="br0">&#40;</span>surfaceTexture<span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
&nbsp;
    <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
    <span class="co3">/** 启动编码 **/</span>
    <span class="kw1">public</span> <span class="kw4">void</span> startMedia<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw2">null</span> <span class="sy0">!=</span> mSegmentedFront <span class="sy0">&amp;&amp;</span> <span class="kw2">null</span> <span class="sy0">!=</span> mSegmentedBack<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mSegmentedFront.<span class="me1">startMediaRecorder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mSegmentedBack.<span class="me1">startMediaRecorder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="co3">/** 停止编码 **/</span>
    <span class="kw1">public</span> <span class="kw4">void</span> stopMedia<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw2">null</span> <span class="sy0">!=</span> mSegmentedFront <span class="sy0">&amp;&amp;</span> <span class="kw2">null</span> <span class="sy0">!=</span> mSegmentedBack<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mSegmentedFront.<span class="me1">releaseMediaRecorder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mSegmentedBack.<span class="me1">releaseMediaRecorder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="co3">/** 销毁编码器与控件 **/</span>
    <span class="kw1">private</span> <span class="kw4">void</span> releaseMediaCamera<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw2">null</span> <span class="sy0">!=</span> mSegmentedFront<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mSegmentedFront.<span class="me1">releaseCameraPreview</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mSegmentedFront.<span class="me1">releaseMediaRecorder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw2">null</span> <span class="sy0">!=</span> mSegmentedBack<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mSegmentedBack.<span class="me1">releaseCameraPreview</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mSegmentedBack.<span class="me1">releaseMediaRecorder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onDestroy<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">super</span>.<span class="me1">onDestroy</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        releaseMediaCamera<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        stopForeground<span class="br0">&#40;</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#125;</span></pre>

3.7&nbsp;&nbsp;MainActivity.java主要关注：moveTaskToBack(true);将Activity推到栈后台，而不是finish()<BR>
<pre class="code java"><span class="kw1">public</span> <span class="kw1">class</span> MainActivity <span class="kw1">extends</span> Activity <span class="kw1">implements</span> OnClickListener <span class="br0">&#123;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw1">static</span> <span class="kw1">final</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> TAG <span class="sy0">=</span> <span class="st0">&quot;SimMainActivity&quot;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw1">static</span> <span class="kw1">final</span> <span class="kw4">int</span> EVT_CANCEL_WELCOME_FRAGMENT <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">private</span> FragmentManager mFragmentManager<span class="sy0">;</span>
    <span class="kw1">private</span> CameraProxy mCameraProxy<span class="sy0">;</span>
    <span class="kw1">private</span> <span class="kw1">static</span> DisplayMetrics mDisplayMetrics<span class="sy0">;</span>
&nbsp;
    <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+button"><span class="kw3">Button</span></a> bt_memory, bt_start, bt_setting<span class="sy0">;</span>
&nbsp;
    SurfaceHolder mSurHolderFront, mSurHolderBack<span class="sy0">;</span>
    <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+timer"><span class="kw3">Timer</span></a> mTimer<span class="sy0">;</span>
&nbsp;
    SegmentedUtil mSegmentedFront<span class="sy0">;</span>
    SegmentedUtil mSegmentedBack<span class="sy0">;</span>
&nbsp;
    <span class="kw4">boolean</span> startFlag <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
    <span class="kw1">private</span> <span class="kw1">static</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a> mContext <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
&nbsp;
    @Override
    <span class="kw1">protected</span> <span class="kw4">void</span> onCreate<span class="br0">&#40;</span>Bundle savedInstanceState<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">super</span>.<span class="me1">onCreate</span><span class="br0">&#40;</span>savedInstanceState<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1">// 屏幕长亮</span>
        getWindow<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">addFlags</span><span class="br0">&#40;</span>WindowManager.<span class="me1">LayoutParams</span>.<span class="me1">FLAG_KEEP_SCREEN_ON</span><span class="br0">&#41;</span><span class="sy0">;</span>
        setContentView<span class="br0">&#40;</span>R.<span class="me1">layout</span>.<span class="me1">activity_main</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mContext <span class="sy0">=</span> <span class="kw1">this</span><span class="sy0">;</span>
        initLayout<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1">// 获取手机屏幕尺寸</span>
        mDisplayMetrics <span class="sy0">=</span> <span class="kw1">new</span> DisplayMetrics<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        getWindowManager<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getDefaultDisplay</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getMetrics</span><span class="br0">&#40;</span>mDisplayMetrics<span class="br0">&#41;</span><span class="sy0">;</span>
        registerBroadcast<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        mFragmentManager <span class="sy0">=</span> getFragmentManager<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        switchFragment<span class="br0">&#40;</span><span class="kw1">new</span> WelcomeFragment<span class="br0">&#40;</span><span class="br0">&#41;</span>, <span class="kw1">new</span> WelcomeFragment<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        startService<span class="br0">&#40;</span><span class="kw1">new</span> Intent<span class="br0">&#40;</span><span class="kw1">this</span>, CameraService.<span class="kw1">class</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mInternalHandler.<span class="me1">sendEmptyMessageDelayed</span><span class="br0">&#40;</span>EVT_CANCEL_WELCOME_FRAGMENT, <span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1">// 检查储存空间</span>
        MemoryUtil.<span class="me1">updateMemory</span><span class="br0">&#40;</span>MainActivity.<span class="kw1">this</span>, bt_memory<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw4">void</span> initLayout<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        bt_memory <span class="sy0">=</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+button"><span class="kw3">Button</span></a><span class="br0">&#41;</span> findViewById<span class="br0">&#40;</span>R.<span class="me1">id</span>.<span class="me1">bt_memory</span><span class="br0">&#41;</span><span class="sy0">;</span>
        bt_start <span class="sy0">=</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+button"><span class="kw3">Button</span></a><span class="br0">&#41;</span> findViewById<span class="br0">&#40;</span>R.<span class="me1">id</span>.<span class="me1">bt_start</span><span class="br0">&#41;</span><span class="sy0">;</span>
        bt_setting <span class="sy0">=</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+button"><span class="kw3">Button</span></a><span class="br0">&#41;</span> findViewById<span class="br0">&#40;</span>R.<span class="me1">id</span>.<span class="me1">bt_setting</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        bt_start.<span class="me1">setOnClickListener</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span>
        bt_setting.<span class="me1">setOnClickListener</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">public</span> <span class="kw1">static</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a> getContext<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> mContext<span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">public</span> <span class="kw1">static</span> DisplayMetrics getDisplayMetrics<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> mDisplayMetrics<span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">public</span> CameraProxy getCameraProxy<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> mCameraProxy<span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">private</span> <span class="kw4">void</span> switchFragment<span class="br0">&#40;</span>Fragment... <span class="me1">fragment</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        FragmentTransaction ft <span class="sy0">=</span> mFragmentManager.<span class="me1">beginTransaction</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        ft.<span class="me1">replace</span><span class="br0">&#40;</span>R.<span class="me1">id</span>.<span class="me1">container_front</span>, fragment<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        ft.<span class="me1">replace</span><span class="br0">&#40;</span>R.<span class="me1">id</span>.<span class="me1">container_back</span>, fragment<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        ft.<span class="me1">commit</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">private</span> Handler mInternalHandler <span class="sy0">=</span> <span class="kw1">new</span> Handler<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">public</span> <span class="kw4">void</span> handleMessage<span class="br0">&#40;</span>android.<span class="me1">os</span>.<span class="me1">Message</span> msg<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">switch</span> <span class="br0">&#40;</span>msg.<span class="me1">what</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw1">case</span> EVT_CANCEL_WELCOME_FRAGMENT<span class="sy0">:</span>
                    <span class="kw1">if</span> <span class="br0">&#40;</span>mCameraProxy <span class="sy0">==</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        sendEmptyMessageDelayed<span class="br0">&#40;</span>EVT_CANCEL_WELCOME_FRAGMENT, <span class="nu0">2000</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                        switchFragment<span class="br0">&#40;</span><span class="kw1">new</span> CameraFragment<span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>, <span class="kw1">new</span> CameraFragment<span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span>
                    <span class="kw1">break</span><span class="sy0">;</span>
                <span class="kw1">default</span><span class="sy0">:</span>
                    Toast.<span class="me1">makeText</span><span class="br0">&#40;</span>MainActivity.<span class="kw1">this</span>, <span class="st0">&quot;Error&quot;</span>, Toast.<span class="me1">LENGTH_SHORT</span><span class="br0">&#41;</span>.<span class="me1">show</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="kw1">break</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
    <span class="co3">/** 连接Service **/</span>
    <span class="kw1">private</span> ServiceConnection mConn <span class="sy0">=</span> <span class="kw1">new</span> ServiceConnection<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">void</span> onServiceDisconnected<span class="br0">&#40;</span>ComponentName name<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mCameraProxy <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        @Override
        <span class="kw1">public</span> <span class="kw4">void</span> onServiceConnected<span class="br0">&#40;</span>ComponentName name, IBinder service<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mCameraProxy <span class="sy0">=</span> <span class="br0">&#40;</span>CameraProxy<span class="br0">&#41;</span> service<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
    <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
    <span class="co3">/** 绑定Service **/</span>
    <span class="kw1">private</span> <span class="kw4">void</span> bindService<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        mCameraProxy <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
        bindService<span class="br0">&#40;</span><span class="kw1">new</span> Intent<span class="br0">&#40;</span>MainActivity.<span class="kw1">this</span>, CameraService.<span class="kw1">class</span><span class="br0">&#41;</span>, mConn,
                Service.<span class="me1">BIND_AUTO_CREATE</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="co3">/** 解除Service绑定 **/</span>
    <span class="kw1">private</span> <span class="kw4">void</span> unbindService<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>mCameraProxy <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mCameraProxy <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
            unbindService<span class="br0">&#40;</span>mConn<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="co3">/** 服务启动后绑定服务 **/</span>
    <span class="kw1">private</span> BroadcastReceiver mReceiver <span class="sy0">=</span> <span class="kw1">new</span> BroadcastReceiver<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        @Override
        <span class="kw1">public</span> <span class="kw4">void</span> onReceive<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a> context, Intent intent<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> action <span class="sy0">=</span> intent.<span class="me1">getAction</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>action.<span class="me1">equals</span><span class="br0">&#40;</span>CameraProxy.<span class="me1">ACTION_SERVICE_CREATED</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                bindService<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
    <span class="co3">/** 注册绑定服务广播 **/</span>
    <span class="kw1">private</span> <span class="kw4">void</span> registerBroadcast<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        IntentFilter filter <span class="sy0">=</span> <span class="kw1">new</span> IntentFilter<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        filter.<span class="me1">addAction</span><span class="br0">&#40;</span>CameraProxy.<span class="me1">ACTION_SERVICE_CREATED</span><span class="br0">&#41;</span><span class="sy0">;</span>
        registerReceiver<span class="br0">&#40;</span>mReceiver, filter<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="co3">/** 销毁绑定服务广播 **/</span>
    <span class="kw1">private</span> <span class="kw4">void</span> unreginsterReceiver<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        unregisterReceiver<span class="br0">&#40;</span>mReceiver<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onClick<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+view"><span class="kw3">View</span></a> v<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">switch</span> <span class="br0">&#40;</span>v.<span class="me1">getId</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">case</span> R.<span class="me1">id</span>.<span class="me1">bt_start</span><span class="sy0">:</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span>startFlag<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    mCameraProxy.<span class="me1">startMediaRecorder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    startFlag <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
                    bt_start.<span class="me1">setText</span><span class="br0">&#40;</span>R.<span class="me1">string</span>.<span class="me1">stop</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                    mCameraProxy.<span class="me1">stopMediaRecorder</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    startFlag <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
                    bt_start.<span class="me1">setText</span><span class="br0">&#40;</span>R.<span class="me1">string</span>.<span class="me1">start</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> R.<span class="me1">id</span>.<span class="me1">bt_setting</span><span class="sy0">:</span>
                DialogView.<span class="me1">showSettingDialog</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="kw1">default</span><span class="sy0">:</span>
                Toast.<span class="me1">makeText</span><span class="br0">&#40;</span>MainActivity.<span class="kw1">this</span>, <span class="st0">&quot;Click error&quot;</span>, Toast.<span class="me1">LENGTH_LONG</span><span class="br0">&#41;</span>.<span class="me1">show</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">public</span> <span class="kw4">void</span> onBackPressed<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        moveTaskToBack<span class="br0">&#40;</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    @Override
    <span class="kw1">protected</span> <span class="kw4">void</span> onDestroy<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">super</span>.<span class="me1">onDestroy</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        unreginsterReceiver<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        unbindService<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        MemoryUtil.<span class="me1">stopTimer</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#125;</span></pre>

</div>
<!-- EDIT4 SECTION "三、关键代码" [1806-] -->