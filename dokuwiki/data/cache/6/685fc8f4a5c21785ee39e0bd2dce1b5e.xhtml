
<p>
— <em><a href="mailto:&#x73;&#x68;&#x75;&#x2e;&#x79;&#x69;&#x6e;&#x40;&#x73;&#x69;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;" class="mail" title="&#x73;&#x68;&#x75;&#x2e;&#x79;&#x69;&#x6e;&#x40;&#x73;&#x69;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">尹姝</a> 2014/2/21</em>
</p>

<h1 class="sectionedit1" id="how_to_get_and_analyze_ram_dump">How to get and analyze RAM dump</h1>
<div class="level1">
<div class="table sectionedit2"><table class="inline">
	<tr class="row0">
		<th class="col0 leftalign">Document Title:     </th><td class="col1">How to get and analyze RAM dump</td>
	</tr>
	<tr class="row1">
		<th class="col0 leftalign">Version:            </th><td class="col1 leftalign">1.01                           </td>
	</tr>
	<tr class="row2">
		<th class="col0 leftalign">Date:               </th><td class="col1 leftalign">2013-04-22                     </td>
	</tr>
	<tr class="row3">
		<th class="col0 leftalign">Status:             </th><td class="col1 leftalign">Release                        </td>
	</tr>
	<tr class="row4">
		<th class="col0">Document Control ID:</th><td class="col1 leftalign">SIM0004                        </td>
	</tr>
	<tr class="row5">
		<th class="col0 leftalign">Writer:             </th><td class="col1 leftalign">Xifangqing                     </td>
	</tr>
</table></div>
<!-- EDIT2 TABLE [92-428] --><hr />

</div>
<!-- EDIT1 SECTION "How to get and analyze RAM dump" [46-437] -->
<h2 class="sectionedit3" id="get_the_ram_dump">Get the RAM dump:</h2>
<div class="level2">

<p>
<strong><span style='color:teal; '>1. </span></strong>In file AMSS/products/7&times;30/build/ms/targaaabqoazm.h, add the following defines: 
</p>
<pre class="code c"><span class="co2">#define FEATURE_DLOAD_HW_RESET_DETECT </span>
<span class="co2">#define FEATURE_DLOAD_MEM_DEBUG </span>
<span class="co2">#define FEATURE_AUTO_DLOAD_ON_ERROR </span>
<span class="co2">#define FEATURE_ERR_EXTENDED_STORE //For EFS logs </span>
<span class="co2">#define FEATURE_QPMD //For QPMD log, </span>
<span class="co2">#define FEATURE_SMEM_LOG </span></pre>

<p>
<strong><span style='color:teal; '>2. </span></strong>Modify file AMSS/products/7&times;30/build/ms/linux_build （In windows “build.cmd”）
</p>
<pre class="code">export BUILD_CMD=&quot;BUILD_ID=$BUILD_ID BUILD_VER=$BUILD_VER MSM_ID=$MSM_ID DEBUG_ON=yes HAL_PLATFORM=$HAL_PLATFORM ..&quot; </pre>

<p>
that is, add “DEBUG_ON=yes” when make build. 
</p>

<p>
<strong><span style='color:teal; '>3. </span></strong>Rebuild AMSS and flash the amss.mbn to the phone by QPST.
</p>

<p>
<strong><span style='color:teal; '>4. </span></strong>Get the RAM dump when the phone had entered into QPST download mode.
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump1.png" class="media" title="doc:ram_dump1.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump1.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump2.png" class="media" title="doc:ram_dump2.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump2.png" class="media" alt="" /></a>
</p>

</div>
<!-- EDIT3 SECTION "Get the RAM dump:" [438-1336] -->
<h2 class="sectionedit4" id="analyze_the_ram_dump_by_trace32_simulator">Analyze the RAM dump by TRACE32 Simulator</h2>
<div class="level2">

<p>
<strong><span style='color:teal; '>1. </span></strong>Copy the RAM dump files to AMSS\products\7&times;30\build\ms
</p>

<p>
<strong><span style='color:teal; '>2. </span></strong>Open Trace32 Simulator,
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump3.png" class="media" title="doc:ram_dump3.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump3.png" class="media" alt="" /></a>
</p>
<pre class="code">cd &quot; AMSS\products\7x30\build\ms &quot;, run &quot;load_log.cmm&quot;,
Select Choice :   &quot;2,8x55(512 MB)&quot;
Select Log Type:  &quot;USB Crash Logs&quot;
Select ELF file:   &quot; AMSS\products\7x30\build\ms\ M7630AAABQOAZM41400700.elf&quot;
Select Log file:   &quot; AMSS\products\7x30\build\ms\load.cmm&quot;
Click  “Go! Load the logs”
Then select OS: choose &quot;2 Android&quot;</pre>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump4.png" class="media" title="doc:ram_dump4.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump4.png" class="media" alt="" /></a>
</p>

<p>
<strong><span style='color:teal; '>3. </span></strong>check MMU_DATA.
</p>

<p>
Open ” AMSS\products\7&times;30\build\ms\quartz_constants_M.cmm ”.
</p>

<p>
<span style='color:royalblue; '>&amp;l4_entry_point=0xb00000</span>
</p>

<p>
<span style='color:royalblue; '>&amp;l4_bootimg=”../../core/kernel/build_m/bootimg.pbn”</span>
</p>

<p>
<span style='color:royalblue; '>&amp;mmu_data =&amp;l4_entry_point+0x1ea68</span>
</p>

<p>
So mmu_data_addr = 0xb1ea68
</p>

<p>
In trace32 simulator,
</p>

<p>
Input command:  <strong>v.v (mmu_data_t *)0xb1ea68</strong> to query this variable.
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump5.png" class="media" title="doc:ram_dump5.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump5.png" class="media" alt="" /></a>
</p>

<p>
<strong>cpu→Peripherals→Memory Management Unit</strong>
</p>

<p>
Check the value of <strong>“CR”=“mmu_cr”,”TTBR0”=“ttb”,”DACR”=“DACR”?</strong>
</p>

<p>
If they are not equal, <strong>double click the data and set it to the right value in command line</strong>.
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump6.png" class="media" title="doc:ram_dump6.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump6.png" class="media" alt="" /></a>
</p>

<p>
<strong><span style='color:teal; '>4. </span></strong>Click <strong>“trace buffer”</strong> icon, it will show all the task and thread.
</p>

<p>
<strong>“Current” task</strong> is most likely where the problem is. 
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump7.png" class="media" title="doc:ram_dump7.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump7.png" class="media" alt="" /></a>
</p>

<p>
<strong><span style='color:teal; '>5. </span></strong>CPU →CPU Registers, set <strong>“CPSR”=0xD0</strong> to change the ARM processor form <strong>SVC mode to user mode</strong>, then SP and CP data can be modified as the user’s wish.
</p>

<p>
Due to fs task crashed, corroding to the ram dump, the call stack may not complete, dog task can be taken as an example for call stack show.
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump8.png" class="media" title="doc:ram_dump8.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump8.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump9.png" class="media" title="doc:ram_dump9.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump9.png" class="media" alt="" /></a>
</p>

<p>
“<strong>R13</strong>” =“Sp” of dog task, “<strong>PC</strong>” =“PC” of dog task,
</p>

<p>
Click “Thread list” icon, double click “ktcb value” of “dog” task,
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump10.png" class="media" title="doc:ram_dump10.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump10.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump11.png" class="media" title="doc:ram_dump11.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump11.png" class="media" alt="" /></a>
</p>

<p>
And input command: <strong>v.f</strong> to show the call stack.
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump12.png" class="media" title="doc:ram_dump12.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump12.png" class="media" alt="" /></a>
</p>

</div>
<!-- EDIT4 SECTION "Analyze the RAM dump by TRACE32 Simulator" [1337-3397] -->
<h2 class="sectionedit5" id="obtain_logs_by_scripts">Obtain logs by scripts:</h2>
<div class="level2">

<p>
<strong><span style='color:teal; '>1. </span></strong>F3 log 
</p>

<p>
Run: “do AMSS\products\7&times;30\build\ms\recover_f3.cmm”.
</p>

<p>
It will generate file C:\temp\f3tokens_temp.txt, some useful logs can be show here.
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump13.png" class="media" title="doc:ram_dump13.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump13.png" class="media" alt="" /></a>
</p>

<p>
<strong><span style='color:teal; '>2. </span></strong>SMEM log
</p>

<p>
Run “do AMSS\products\7&times;30\tools\debug\smemlog.cmm” in Trace32
</p>

<p>
It will generate “smem_log*.lst” in AMSS\products\7&times;30\build\ms.
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump14.png" class="media" title="doc:ram_dump14.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump14.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump15.png" class="media" title="doc:ram_dump15.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump15.png" class="media" alt="" /></a>
</p>

<p>
Copy “AMSS\products\7&times;30\tools\debug\smem_log.pl” to “AMSS\products\7&times;30\build\ms”,
</p>

<p>
And run “perl smem_log.pl &gt; smemlog.txt” in cygwin.(C:\cygwin\Cygwin.bat)
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump16.png" class="media" title="doc:ram_dump16.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump16.png" class="media" alt="" /></a>
</p>

<p>
Then you can analysis the SMEM log in “smemlog.txt”.
</p>

</div>
<!-- EDIT5 SECTION "Obtain logs by scripts:" [3398-4113] -->
<h2 class="sectionedit6" id="dump_the_current_crash_task_call_stack">Dump the current crash task call stack:</h2>
<div class="level2">

<p>
As the description above, the current crash task is “fs_task”, so set command in Trace32 Simultor:
</p>

<p>
<strong><span style='color:teal; '>1. </span></strong><strong>symbol.BROWSE fs_stack</strong> to show the range of it, and
</p>

<p>
<strong><span style='color:teal; '>2. </span></strong><strong>d.dump “bottom address of the stack”</strong>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump17.png" class="media" title="doc:ram_dump17.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump17.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump18.png" class="media" title="doc:ram_dump18.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump18.png" class="media" alt="" /></a>
</p>

<p>
Almost all of the crash issue will call below functions in file <strong>err.c</strong>:
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump19.png" class="media" title="doc:ram_dump19.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump19.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump20.png" class="media" title="doc:ram_dump20.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump20.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump21.png" class="media" title="doc:ram_dump21.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump21.png" class="media" alt="" /></a>
</p>

<p>
So  <strong>sYmbol.BROWSE err_emergency_error_recovery</strong>
</p>

<p>
<strong>sYmbol.BROWSE err_fatal_handler</strong>
</p>

<p>
<strong>sYmbol.BROWSE err_fatal_put_log</strong>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump22.png" class="media" title="doc:ram_dump22.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump22.png" class="media" alt="" /></a>
</p>

<p>
Then you can found these err handler address(E7A125,E7A13F,E7A245..) in fs_stack dump. Then set command <strong>“d.l E7A125 ”</strong> . So, it is indeed that some fatal error happened in fs_stack. 
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump23.png" class="media" title="doc:ram_dump23.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump23.png" class="media" alt="" /></a>
</p>

<p>
CPU register R14 is for error handler, set it value as 0xE7A125, and set PC=0xE7A0FC (function <strong>err_emergency_error_recovery(asm)</strong>).You can set SP address(R13) as you wish(must in the range of  fs_stack), it will show different call stack when V.F command is set.
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump24.png" class="media" title="doc:ram_dump24.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump24.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump25.png" class="media" title="doc:ram_dump25.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump25.png" class="media" alt="" /></a>
</p>

<p>
<a href="/dokuwiki/lib/exe/detail.php?id=android%3Ahow_to_get_and_analyze_ram_dump&amp;media=doc:ram_dump26.png" class="media" title="doc:ram_dump26.png"><img src="/dokuwiki/lib/exe/fetch.php?media=doc:ram_dump26.png" class="media" alt="" /></a>
</p>

</div>
<!-- EDIT6 SECTION "Dump the current crash task call stack:" [4114-5324] -->
<h2 class="sectionedit7" id="参考文档">参考文档：</h2>
<div class="level2">

<p>
80-VN752-2_B_Stability_Debugging_Guide.pdf
</p>

</div>
<!-- EDIT7 SECTION "参考文档：" [5325-] -->