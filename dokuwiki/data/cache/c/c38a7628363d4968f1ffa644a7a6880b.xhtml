
<h3 class="sectionedit1" id="关于camera录制视频的分析">关于camera录制视频的分析</h3>
<div class="level3">

</div>

<h4 id="camera_录像流程">camera 录像流程</h4>
<div class="level4">
<pre class="code">  1. camera模块将从hal层的预览线程中，获取原始的未压缩的yvu视屏帧，通过回调函数传递到CameraSource模块。
  
  2. OMXCodec模块将从CameraSource模块的read接口获取yuv视频帧拷贝到编码模块提供的输入端口的buffer列表中。
      编码模块从输入端口的buffer列表读取包含yuv的buffer、编码、然后送回到输出端口的buffer列表，供OMXCodec模块取回。
      
  3. 从OMXCodec模块的read接口读取压缩编码后的h264帧，通过TS容器写到输出文件句柄上，得到TS流的文件。
  </pre>

</div>

<h4 id="camera_的视频预览流程">camera 的视频预览流程</h4>
<div class="level4">
<pre class="code">  1. mediaserver进程是Camera Service的容器进程，它会动态加载Camera HAL和Gralloc HAL。
      视频数据帧首先必须从Camera驱动程序到达Camera硬件抽象层。
      在Camera硬件抽象层，视频数据帧被从video capture buffer拷贝到gralloc buffer。</pre>
<pre class="code">  2. surfaceflinger进程作为显示服务器会动态加载HWComposer HAL和Gralloc HAL。
      在HWComposer硬件抽象层，会把数据帧从gralloc buffer拷贝到video output buffer。</pre>
<pre class="code">  3. 经过上述过程，Camera Sensor采集的图像最终通过LCDC HEO显示在显示屏上。</pre>

</div>
<!-- EDIT1 SECTION "关于camera录制视频的分析" [1-1300] -->
<h3 class="sectionedit2" id="录制视频模糊的分析">录制视频模糊的分析</h3>
<div class="level3">

<p>
录制视频之后可能出现模糊、花屏等情况，在分析具体问题之前。可以尝试dump input/output相关数据，缩小问题的范围。
具体方法如下：
</p>
<pre class="code c">adb root 
adb remount 
adb shell chmod <span class="nu0">777</span> <span class="sy0">/</span>data<span class="sy0">/</span>misc<span class="sy0">/</span>media 
adb shell setprop vidc.<span class="me1">enc</span>.<a href="http://www.opengroup.org/onlinepubs/009695399/functions/log.html"><span class="kw3">log</span></a>.<span class="me1">in</span> <span class="nu0">1</span> 
adb shell getprop vidc.<span class="me1">enc</span>.<a href="http://www.opengroup.org/onlinepubs/009695399/functions/log.html"><span class="kw3">log</span></a>.<span class="me1">in</span> <span class="co1">//ensure this value is set.</span>
adb shell setprop vidc.<span class="me1">enc</span>.<a href="http://www.opengroup.org/onlinepubs/009695399/functions/log.html"><span class="kw3">log</span></a>.<span class="me1">out</span> <span class="nu0">1</span> 
adb shell getprop vidc.<span class="me1">enc</span>.<a href="http://www.opengroup.org/onlinepubs/009695399/functions/log.html"><span class="kw3">log</span></a>.<span class="me1">out</span> <span class="co1">//ensure this value is set.</span></pre>

<p>
h264/yuv 数据将会被存储在手机目录 /data/misc/media/下。
利用ffplay去播放原始数据和编码之后的数据，查看是否存在模糊的现象。
</p>
<pre class="code">  播放方法：
  ffplay -f rawvideo -video_size 1920x1080 ***.yuv
  ffplay ***.h264</pre>

<p>
如果存在“chmod: chmod &#039;/data/misc/media&#039; to 40777: Permission denied”的情况，主要是因为selinux访问控制导致。
</p>

<p>
解决方法：
adb shell setenforce 0即可。
</p>

<p>
ffplay可以在linux环境下安装，也可直接使用可执行文件。可执行文件我放在共享里了。
</p>

<p>
路径smb:<em>192.167.100.225/share/Tool/ffplay
<img src="/lib/images/smileys/icon_razz.gif" class="icon" alt=":-P" />
 — </em><a href="mailto:&#x6a;&#x69;&#x6e;&#x78;&#x69;&#x6e;&#x2e;&#x6c;&#x69;&#x75;&#x40;&#x73;&#x69;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;" class="mail" title="&#x6a;&#x69;&#x6e;&#x78;&#x69;&#x6e;&#x2e;&#x6c;&#x69;&#x75;&#x40;&#x73;&#x69;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">jinxin.liu</a> 2017/02/08 09:24<em>
</p>

</div>
<!-- EDIT2 SECTION "录制视频模糊的分析" [1301-] -->