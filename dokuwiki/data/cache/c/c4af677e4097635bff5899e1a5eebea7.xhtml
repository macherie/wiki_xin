
<h1 class="sectionedit1" id="概述">概述</h1>
<div class="level1">

<p>
录音模块主要包含三个类，Recorder.java，SoundRecorder.java，VUMeter.java。Recorder类负责SoundRecorder的全部功能方面的实现，它包含一个MediaRecorder成员和一个MediaPlayer成员，并封装了这两个成员的相关操作。该类向SoundRecorder类提供一系列的接口来控制录音和播放录音的过程。SoundRecorder类本身是一个Activity。该类负责实现一切向用户显示的部分：包括界面，对各种操作的响应。录音、保存录音、播放录音等功能通过调用Recorder类中的方法实现。在SoundRecorder中包含一个Recorder类的对象mRecorder。VUMeter类继承自View类，是一个自定义组件，在界面中用于向用户显示录音时音量的大小。
</p>

</div>
<!-- EDIT1 SECTION "概述" [1-774] -->
<h1 class="sectionedit2" id="recorderjava">Recorder.java</h1>
<div class="level1">

<p>
Recorder类有两个重要的成员变量：录音器和播放器
</p>
<pre class="code java">    MediaRecorder mRecorder <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
    MediaPlayer mPlayer <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span></pre>

<p>
分别在startRecording方法和startPlayback方法中得到初始化，其中startRecording方法是启动录音功能
</p>
<pre class="code java">    <span class="kw1">public</span> <span class="kw4">void</span> startRecording<span class="br0">&#40;</span><span class="kw4">int</span> outputfileformat, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> extension, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a> context, <span class="kw4">int</span> audiosourcetype, <span class="kw4">int</span> codectype<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        stop<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        mSampleFile <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>mSampleFile <span class="sy0">==</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="co1">//File sampleDir = Environment.getExternalStorageDirectory();</span>
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+file"><span class="kw3">File</span></a> sampleDir <span class="sy0">=</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+file"><span class="kw3">File</span></a><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+environment"><span class="kw3">Environment</span></a>.<span class="me1">getExternalStorageDirectory</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getPath</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">&quot;/RECORDER&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>sampleDir.<span class="me1">exists</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                sampleDir.<span class="me1">mkdirs</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">;</span>
            <span class="br0">&#125;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>sampleDir.<span class="me1">canWrite</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="co1">// Workaround for broken sdcard support on the device.</span>
                sampleDir <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+environment"><span class="kw3">Environment</span></a>.<span class="me1">getExternalStorageDirectory</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+stringbuffer"><span class="kw3">StringBuffer</span></a> lFileName <span class="sy0">=</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+stringbuffer"><span class="kw3">StringBuffer</span></a><span class="br0">&#40;</span><span class="st0">&quot;Recorder-&quot;</span><span class="br0">&#41;</span> <span class="sy0">;</span>
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+time"><span class="kw3">Time</span></a> time <span class="sy0">=</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+time"><span class="kw3">Time</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            time.<span class="me1">setToNow</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> day <span class="sy0">=</span> time.<span class="me1">format2445</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span><span class="br0">&#40;</span>day.<span class="me1">contains</span><span class="br0">&#40;</span><span class="st0">&quot;T&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                day <span class="sy0">=</span> day.<span class="me1">replace</span><span class="br0">&#40;</span><span class="st0">&quot;T&quot;</span>, <span class="st0">&quot;_&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
            lFileName.<span class="me1">append</span><span class="br0">&#40;</span>day<span class="br0">&#41;</span><span class="sy0">;</span>
            lFileName.<span class="me1">append</span><span class="br0">&#40;</span>extension<span class="br0">&#41;</span> <span class="sy0">;</span>
&nbsp;
            <span class="kw1">try</span> <span class="br0">&#123;</span>
                <span class="co1">//mSampleFile = File.createTempFile(SAMPLE_PREFIX, extension, sampleDir);</span>
                mSampleFile <span class="sy0">=</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+file"><span class="kw3">File</span></a><span class="br0">&#40;</span>sampleDir, lFileName.<span class="me1">toString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">catch</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+exception"><span class="kw3">Exception</span></a> e<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                setError<span class="br0">&#40;</span>SDCARD_ACCESS_ERROR<span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">return</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
        mRecorder <span class="sy0">=</span> <span class="kw1">new</span> MediaRecorder<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mRecorder.<span class="me1">setAudioSource</span><span class="br0">&#40;</span>audiosourcetype<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1">//set channel for surround sound recording.</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>mChannels <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mRecorder.<span class="me1">setAudioChannels</span><span class="br0">&#40;</span>mChannels<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>mSamplingRate <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mRecorder.<span class="me1">setAudioSamplingRate</span><span class="br0">&#40;</span>mSamplingRate<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        mRecorder.<span class="me1">setOutputFormat</span><span class="br0">&#40;</span>outputfileformat<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">try</span> <span class="br0">&#123;</span>
            mRecorder.<span class="me1">setAudioEncoder</span><span class="br0">&#40;</span>codectype<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">catch</span><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+runtimeexception"><span class="kw3">RuntimeException</span></a> exception<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            setError<span class="br0">&#40;</span>UNSUPPORTED_FORMAT<span class="br0">&#41;</span><span class="sy0">;</span>
            mRecorder.<span class="me1">reset</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mRecorder.<span class="me1">release</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>mSampleFile <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span>
               mSampleFile.<span class="me1">delete</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mSampleFile <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
            mSampleLength <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
            mRecorder <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
            <span class="kw1">return</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        mRecorder.<span class="me1">setOutputFile</span><span class="br0">&#40;</span>mSampleFile.<span class="me1">getAbsolutePath</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Handle IOException</span>
        <span class="kw1">try</span> <span class="br0">&#123;</span>
            mRecorder.<span class="me1">prepare</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">catch</span><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+ioexception"><span class="kw3">IOException</span></a> exception<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            setError<span class="br0">&#40;</span>RECORDING<span class="br0">&#41;</span><span class="sy0">;</span>
            mRecorder.<span class="me1">reset</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mRecorder.<span class="me1">release</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>mSampleFile <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span>
               mSampleFile.<span class="me1">delete</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mSampleFile <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
            mSampleLength <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
            mRecorder <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
            <span class="kw1">return</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="co1">// Handle RuntimeException if the recording couldn't start</span>
        Log.<span class="me1">e</span><span class="br0">&#40;</span>TAG,<span class="st0">&quot;audiosourcetype &quot;</span> <span class="sy0">+</span>audiosourcetype<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">try</span> <span class="br0">&#123;</span>
            mRecorder.<span class="me1">start</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">catch</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+runtimeexception"><span class="kw3">RuntimeException</span></a> exception<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            AudioManager audioMngr <span class="sy0">=</span> <span class="br0">&#40;</span>AudioManager<span class="br0">&#41;</span>context.<span class="me1">getSystemService</span><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a>.<span class="me1">AUDIO_SERVICE</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw4">boolean</span> isInCall <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>audioMngr.<span class="me1">getMode</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> AudioManager.<span class="me1">MODE_IN_CALL</span><span class="br0">&#41;</span> <span class="sy0">||</span>
                    <span class="br0">&#40;</span>audioMngr.<span class="me1">getMode</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> AudioManager.<span class="me1">MODE_IN_COMMUNICATION</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>isInCall<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span>isVTCall<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    setError<span class="br0">&#40;</span>IN_VIDEO_CALL_ERROR<span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                    setError<span class="br0">&#40;</span>IN_CALL_RECORD_ERROR<span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                setError<span class="br0">&#40;</span>RECORDING<span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
            mRecorder.<span class="me1">reset</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mRecorder.<span class="me1">release</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>mSampleFile <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span>
                mSampleFile.<span class="me1">delete</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mSampleFile <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
            mSampleLength <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
            mRecorder <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
            <span class="kw1">return</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        mSampleStart <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span class="kw3">System</span></a>.<span class="me1">currentTimeMillis</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        setState<span class="br0">&#40;</span>RECORDING_STATE<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span></pre>

<p>
而startPlayback方法的功能是开始播放持有的录音文件
</p>
<pre class="code java">    <span class="kw1">public</span> <span class="kw4">void</span> startPlayback<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        stop<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        mPlayer <span class="sy0">=</span> <span class="kw1">new</span> MediaPlayer<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">try</span> <span class="br0">&#123;</span>
            mPlayer.<span class="me1">setDataSource</span><span class="br0">&#40;</span>mSampleFile.<span class="me1">getAbsolutePath</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mPlayer.<span class="me1">setOnCompletionListener</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mPlayer.<span class="me1">setOnErrorListener</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mPlayer.<span class="me1">prepare</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            mPlayer.<span class="me1">start</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">catch</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+illegalargumentexception"><span class="kw3">IllegalArgumentException</span></a> e<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            setError<span class="br0">&#40;</span>INTERNAL_ERROR<span class="br0">&#41;</span><span class="sy0">;</span>
            mPlayer <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
            <span class="kw1">return</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">catch</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+ioexception"><span class="kw3">IOException</span></a> e<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            setError<span class="br0">&#40;</span>SDCARD_ACCESS_ERROR<span class="br0">&#41;</span><span class="sy0">;</span>
            mPlayer <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
            <span class="kw1">return</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        mSampleStart <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span class="kw3">System</span></a>.<span class="me1">currentTimeMillis</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        setState<span class="br0">&#40;</span>PLAYING_STATE<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span></pre>

<p>
与启动录音相对应的是关闭录音功能
</p>
<pre class="code java">    <span class="kw1">public</span> <span class="kw4">void</span> stopRecording<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>mRecorder <span class="sy0">==</span> <span class="kw2">null</span><span class="br0">&#41;</span>
            <span class="kw1">return</span><span class="sy0">;</span>
&nbsp;
        mRecorder.<span class="me1">stop</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mRecorder.<span class="me1">reset</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mRecorder.<span class="me1">release</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mRecorder <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
&nbsp;
        mSampleLength <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span><span class="br0">&#40;</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span class="kw3">System</span></a>.<span class="me1">currentTimeMillis</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">-</span> mSampleStart<span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">1000</span> <span class="br0">&#41;</span><span class="sy0">;</span>
        setState<span class="br0">&#40;</span>IDLE_STATE<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span></pre>

<p>
startPlayback方法是开始播放持有的录音文件，相应的就会有停止播放功能
</p>
<pre class="code java">    <span class="kw1">public</span> <span class="kw4">void</span> stopPlayback<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>mPlayer <span class="sy0">==</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="co1">// we were not in playback</span>
            <span class="kw1">return</span><span class="sy0">;</span>
&nbsp;
        mPlayer.<span class="me1">stop</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mPlayer.<span class="me1">release</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mPlayer <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
        setState<span class="br0">&#40;</span>IDLE_STATE<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span></pre>

<p>
暂停播放
</p>
<pre class="code java">    <span class="kw1">public</span> <span class="kw4">void</span> pausePlayback<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>mPlayer <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
            <span class="kw1">if</span><span class="br0">&#40;</span>mPlayer.<span class="me1">isPlaying</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
                mPlaybackPause <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
                mPlayer.<span class="me1">pause</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span></pre>

<p>
继续播放
</p>
<pre class="code java">    <span class="kw1">public</span> <span class="kw4">void</span> resumePlayback<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>mPlayer <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
            <span class="kw1">if</span><span class="br0">&#40;</span>mPlaybackPause<span class="br0">&#41;</span><span class="br0">&#123;</span>
                mPlaybackPause <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
                mPlayer.<span class="me1">start</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span></pre>

</div>
<!-- EDIT2 SECTION "Recorder.java" [775-6780] -->
<h1 class="sectionedit3" id="soundrecorderjava">SoundRecorder.java</h1>
<div class="level1">

<p>
SoundRecorder类中有个内部类RemainingTimeCalculator。它负责计算存储介质剩余空间能够存放多长的录音文件。其中的timeRemaining()函数负责计算剩余时间，取文件大小限制和空间大小限制的较小的一个来计算剩余时间。
</p>
<pre class="code java">    <span class="kw1">public</span> <span class="kw4">long</span> timeRemaining<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1">// Calculate how long we can record based on free disk space</span>
&nbsp;
        StatFs fs <span class="sy0">=</span> <span class="kw1">new</span> StatFs<span class="br0">&#40;</span>mSDCardDirectory.<span class="me1">getAbsolutePath</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1">//long blocks = fs.getAvailableBlocks();</span>
        <span class="kw4">long</span> blocks <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
        <span class="kw1">if</span><span class="br0">&#40;</span>fs.<span class="me1">getAvailableBlocks</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">-</span> SDCRAD_LAST_SPACE <span class="sy0">&gt;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
            blocks <span class="sy0">=</span> fs.<span class="me1">getAvailableBlocks</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">-</span> SDCRAD_LAST_SPACE<span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw4">long</span> blockSize <span class="sy0">=</span> fs.<span class="me1">getBlockSize</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw4">long</span> now <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span class="kw3">System</span></a>.<span class="me1">currentTimeMillis</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">if</span> <span class="br0">&#40;</span>mBlocksChangedTime <span class="sy0">==</span> <span class="sy0">-</span><span class="nu0">1</span> <span class="sy0">||</span> blocks <span class="sy0">!=</span> mLastBlocks<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mBlocksChangedTime <span class="sy0">=</span> now<span class="sy0">;</span>
            mLastBlocks <span class="sy0">=</span> blocks<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="coMULTI">/* The calculation below always leaves one free block, since free space
           in the block we're currently writing to is not added. This
           last block might get nibbled when we close and flush the file, but 
           we won't run out of disk. */</span>
&nbsp;
        <span class="co1">// at mBlocksChangedTime we had this much time</span>
        <span class="kw4">long</span> result <span class="sy0">=</span> mLastBlocks<span class="sy0">*</span>blockSize<span class="sy0">/</span>mBytesPerSecond<span class="sy0">;</span>
        <span class="co1">// so now we have this much time</span>
        result <span class="sy0">-=</span> <span class="br0">&#40;</span>now <span class="sy0">-</span> mBlocksChangedTime<span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">1000</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">if</span> <span class="br0">&#40;</span>mRecordingFile <span class="sy0">==</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mCurrentLowerLimit <span class="sy0">=</span> DISK_SPACE_LIMIT<span class="sy0">;</span>
            <span class="kw1">return</span> result<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="co1">// If we have a recording file set, we calculate a second estimate</span>
        <span class="co1">// based on how long it will take us to reach mMaxBytes.</span>
&nbsp;
        mRecordingFile <span class="sy0">=</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+file"><span class="kw3">File</span></a><span class="br0">&#40;</span>mRecordingFile.<span class="me1">getAbsolutePath</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw4">long</span> fileSize <span class="sy0">=</span> mRecordingFile.<span class="me1">length</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>mFileSizeChangedTime <span class="sy0">==</span> <span class="sy0">-</span><span class="nu0">1</span> <span class="sy0">||</span> fileSize <span class="sy0">!=</span> mLastFileSize<span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mFileSizeChangedTime <span class="sy0">=</span> now<span class="sy0">;</span>
            mLastFileSize <span class="sy0">=</span> fileSize<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="kw4">long</span> result2 <span class="sy0">=</span> <span class="br0">&#40;</span>mMaxBytes <span class="sy0">-</span> fileSize<span class="br0">&#41;</span><span class="sy0">/</span>mBytesPerSecond<span class="sy0">;</span>
        result2 <span class="sy0">-=</span> <span class="br0">&#40;</span>now <span class="sy0">-</span> mFileSizeChangedTime<span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">1000</span><span class="sy0">;</span>
        result2 <span class="sy0">-=</span> <span class="nu0">1</span><span class="sy0">;</span> <span class="co1">// just for safety</span>
&nbsp;
        mCurrentLowerLimit <span class="sy0">=</span> result <span class="sy0">&lt;</span> result2
            <span class="sy0">?</span> DISK_SPACE_LIMIT <span class="sy0">:</span> FILE_SIZE_LIMIT<span class="sy0">;</span>
&nbsp;
        <span class="kw1">return</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+math"><span class="kw3">Math</span></a>.<span class="me1">min</span><span class="br0">&#40;</span>result, result2<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span></pre>

<p>
在onCreate方法里初始化界面组件与成员变量，其中初始化了mRecorder变量，之后的录音与播放功能都是用该变量实现的。
</p>
<pre class="code java">    <span class="kw1">public</span> <span class="kw4">void</span> onCreate<span class="br0">&#40;</span>Bundle icycle<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">super</span>.<span class="me1">onCreate</span><span class="br0">&#40;</span>icycle<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        Intent intent <span class="sy0">=</span> getIntent<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>intent <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> s <span class="sy0">=</span> intent.<span class="me1">getType</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>AUDIO_AMR.<span class="me1">equals</span><span class="br0">&#40;</span>s<span class="br0">&#41;</span> <span class="sy0">||</span> AUDIO_3GPP.<span class="me1">equals</span><span class="br0">&#40;</span>s<span class="br0">&#41;</span> <span class="sy0">||</span> AUDIO_ANY.<span class="me1">equals</span><span class="br0">&#40;</span>s<span class="br0">&#41;</span>
                    <span class="sy0">||</span> ANY_ANY.<span class="me1">equals</span><span class="br0">&#40;</span>s<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                mRequestedType <span class="sy0">=</span> s<span class="sy0">;</span>
            <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>s <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                <span class="co1">// we only support amr and 3gpp formats right now </span>
                setResult<span class="br0">&#40;</span>RESULT_CANCELED<span class="br0">&#41;</span><span class="sy0">;</span>
                finish<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">return</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
&nbsp;
            <span class="kw1">final</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> EXTRA_MAX_BYTES
                <span class="sy0">=</span> android.<span class="me1">provider</span>.<span class="me1">MediaStore</span>.<span class="me1">Audio</span>.<span class="me1">Media</span>.<span class="me1">EXTRA_MAX_BYTES</span><span class="sy0">;</span>
            mMaxFileSize <span class="sy0">=</span> intent.<span class="me1">getLongExtra</span><span class="br0">&#40;</span>EXTRA_MAX_BYTES, <span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        <span class="kw1">if</span> <span class="br0">&#40;</span>AUDIO_ANY.<span class="me1">equals</span><span class="br0">&#40;</span>mRequestedType<span class="br0">&#41;</span> <span class="sy0">||</span> ANY_ANY.<span class="me1">equals</span><span class="br0">&#40;</span>mRequestedType<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            mRequestedType <span class="sy0">=</span> AUDIO_3GPP<span class="sy0">;</span>
        <span class="br0">&#125;</span>
&nbsp;
        mRequestedType <span class="sy0">=</span> AUDIO_AMR<span class="sy0">;</span> <span class="co1">// Default type</span>
&nbsp;
        setContentView<span class="br0">&#40;</span>R.<span class="me1">layout</span>.<span class="me1">main</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        mRecorder <span class="sy0">=</span> <span class="kw1">new</span> Recorder<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mRecorder.<span class="me1">setOnStateChangedListener</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mRemainingTimeCalculator <span class="sy0">=</span> <span class="kw1">new</span> RemainingTimeCalculator<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        PowerManager pm 
            <span class="sy0">=</span> <span class="br0">&#40;</span>PowerManager<span class="br0">&#41;</span> getSystemService<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a>.<span class="me1">POWER_SERVICE</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mWakeLock <span class="sy0">=</span> pm.<span class="me1">newWakeLock</span><span class="br0">&#40;</span>PowerManager.<span class="me1">SCREEN_DIM_WAKE_LOCK</span>, 
                                    <span class="st0">&quot;SoundRecorder&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        initResourceRefs<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        setResult<span class="br0">&#40;</span>RESULT_CANCELED<span class="br0">&#41;</span><span class="sy0">;</span>
        registerExternalStorageListener<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        registerPowerOffListener<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>icycle <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            Bundle recorderState <span class="sy0">=</span> icycle.<span class="me1">getBundle</span><span class="br0">&#40;</span>RECORDER_STATE_KEY<span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>recorderState <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                mRecorder.<span class="me1">restoreState</span><span class="br0">&#40;</span>recorderState<span class="br0">&#41;</span><span class="sy0">;</span>
                mSampleInterrupted <span class="sy0">=</span> recorderState.<span class="me1">getBoolean</span><span class="br0">&#40;</span>SAMPLE_INTERRUPTED_KEY, <span class="kw2">false</span><span class="br0">&#41;</span><span class="sy0">;</span>
                mMaxFileSize <span class="sy0">=</span> recorderState.<span class="me1">getLong</span><span class="br0">&#40;</span>MAX_FILE_SIZE_KEY, <span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
                <span class="kw4">int</span> showAndExit <span class="sy0">=</span> recorderState.<span class="me1">getInt</span><span class="br0">&#40;</span>DIALOG_STATE_KEY<span class="br0">&#41;</span><span class="sy0">;</span>
                mLastFileName <span class="sy0">=</span> recorderState.<span class="me1">getString</span><span class="br0">&#40;</span>LAST_FILE_NAME_KEY<span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span>showAndExit <span class="sy0">!=</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span> showDialogAndExit<span class="br0">&#40;</span>showAndExit <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
        mTelephonyManager <span class="sy0">=</span> <span class="br0">&#40;</span>TelephonyManager<span class="br0">&#41;</span> getSystemService<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a>.<span class="me1">TELEPHONY_SERVICE</span><span class="br0">&#41;</span><span class="sy0">;</span>
        mPhoneStateListener <span class="sy0">=</span> getPhoneStateListener<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        AudioManager audioManager <span class="sy0">=</span> <span class="br0">&#40;</span>AudioManager<span class="br0">&#41;</span>getSystemService<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a>.<span class="me1">AUDIO_SERVICE</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span class="kw3">String</span></a> ssrRet <span class="sy0">=</span> audioManager.<span class="me1">getParameters</span><span class="br0">&#40;</span><span class="st0">&quot;ssr&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span>ssrRet.<span class="me1">contains</span><span class="br0">&#40;</span><span class="st0">&quot;=true&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            Log.<span class="me1">d</span><span class="br0">&#40;</span>TAG,<span class="st0">&quot;Surround sound recording is supported&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            bSSRSupported <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
            Log.<span class="me1">d</span><span class="br0">&#40;</span>TAG,<span class="st0">&quot;Surround sound recording is not supported&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            bSSRSupported <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        bHandleKeyEvt <span class="sy0">=</span> SystemProperties.<span class="me1">getBoolean</span><span class="br0">&#40;</span><span class="st0">&quot;debug.soundrecorder.encoding&quot;</span>, <span class="kw2">false</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        updateUi<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1">//{[SIMT-lizhonggui-2013-08-28] the bug 8763</span>
        <span class="kw1">final</span> IntentFilter recorderStateFilter <span class="sy0">=</span> <span class="kw1">new</span> IntentFilter<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        recorderStateFilter.<span class="me1">addAction</span><span class="br0">&#40;</span>ACTION_CAMERA_CAPTURE<span class="br0">&#41;</span><span class="sy0">;</span>
        recorderStateFilter.<span class="me1">addAction</span><span class="br0">&#40;</span>ACTION_THEME_CHANGE<span class="br0">&#41;</span><span class="sy0">;</span>
        recorderStateFilter.<span class="me1">addAction</span><span class="br0">&#40;</span>Intent.<span class="me1">ACTION_LOCALE_CHANGED</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        mRecorderStateReceiver <span class="sy0">=</span> <span class="kw1">new</span> RecorderStateReceiver<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        registerReceiver<span class="br0">&#40;</span>mRecorderStateReceiver, recorderStateFilter<span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="co1">//[SIMT-lizhonggui-2013-08-28] the bug 8763}</span>
    <span class="br0">&#125;</span></pre>

<p>
对录音和播放的各个功能比如开始，暂停等功能的实现主要是如下方法：
</p>
<pre class="code java">    <span class="kw1">public</span> <span class="kw4">void</span> onClick<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+view"><span class="kw3">View</span></a> button<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>button.<span class="me1">isEnabled</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
            <span class="kw1">return</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">switch</span> <span class="br0">&#40;</span>button.<span class="me1">getId</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">case</span> R.<span class="me1">id</span>.<span class="me1">recordButton</span><span class="sy0">:</span>
                mRemainingTimeCalculator.<span class="me1">reset</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+environment"><span class="kw3">Environment</span></a>.<span class="me1">getExternalStorageState</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">equals</span><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+environment"><span class="kw3">Environment</span></a>.<span class="me1">MEDIA_MOUNTED</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    mSampleInterrupted <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
                    <span class="co1">// When turn on usb storage, sd card is unavailable.</span>
                    mErrorUiMessage <span class="sy0">=</span> getResources<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getString</span><span class="br0">&#40;</span>R.<span class="me1">string</span>.<span class="me1">sd_card_unavailable</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    updateUi<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>mRemainingTimeCalculator.<span class="me1">diskSpaceAvailable</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                    mSampleInterrupted <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
                    mErrorUiMessage <span class="sy0">=</span> getResources<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getString</span><span class="br0">&#40;</span>R.<span class="me1">string</span>.<span class="me1">storage_is_full</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    updateUi<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                    stopAudioPlayback<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    AudioManager audioManager <span class="sy0">=</span> <span class="br0">&#40;</span>AudioManager<span class="br0">&#41;</span>getSystemService<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+context"><span class="kw3">Context</span></a>.<span class="me1">AUDIO_SERVICE</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="co1">//because of send broadcast to OFF FM is an asynchronous Process</span>
                    <span class="co1">//so sometimes it need little time,Otherwise startRecordin will be error</span>
                    <span class="kw1">if</span> <span class="br0">&#40;</span>audioManager.<span class="me1">isFMActive</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        SystemClock.<span class="me1">sleep</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span>
&nbsp;
                    mRecorder.<span class="me1">removeObsoletedFile</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="kw1">if</span> <span class="br0">&#40;</span>AUDIO_AMR.<span class="me1">equals</span><span class="br0">&#40;</span>mRequestedType<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        mRemainingTimeCalculator.<span class="me1">setBitRate</span><span class="br0">&#40;</span>BITRATE_AMR<span class="br0">&#41;</span><span class="sy0">;</span>
                        mRecorder.<span class="me1">startRecording</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">OutputFormat</span>.<span class="me1">RAW_AMR</span>, <span class="st0">&quot;.amr&quot;</span>, <span class="kw1">this</span>, mAudioSourceType, MediaRecorder.<span class="me1">AudioEncoder</span>.<span class="me1">AMR_NB</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>AUDIO_EVRC.<span class="me1">equals</span><span class="br0">&#40;</span>mRequestedType<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        mRemainingTimeCalculator.<span class="me1">setBitRate</span><span class="br0">&#40;</span>BITRATE_AMR<span class="br0">&#41;</span><span class="sy0">;</span>
                        mRecorder.<span class="me1">startRecording</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">OutputFormat</span>.<span class="me1">QCP</span>, <span class="st0">&quot;.qcp&quot;</span>, <span class="kw1">this</span>, mAudioSourceType, MediaRecorder.<span class="me1">AudioEncoder</span>.<span class="me1">EVRC</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>AUDIO_QCELP.<span class="me1">equals</span><span class="br0">&#40;</span>mRequestedType<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        mRemainingTimeCalculator.<span class="me1">setBitRate</span><span class="br0">&#40;</span>BITRATE_AMR<span class="br0">&#41;</span><span class="sy0">;</span>
                        mRecorder.<span class="me1">startRecording</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">OutputFormat</span>.<span class="me1">QCP</span>, <span class="st0">&quot;.qcp&quot;</span>, <span class="kw1">this</span>, mAudioSourceType, MediaRecorder.<span class="me1">AudioEncoder</span>.<span class="me1">QCELP</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>AUDIO_3GPP.<span class="me1">equals</span><span class="br0">&#40;</span>mRequestedType<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        mRemainingTimeCalculator.<span class="me1">setBitRate</span><span class="br0">&#40;</span>BITRATE_3GPP<span class="br0">&#41;</span><span class="sy0">;</span>
                        mRecorder.<span class="me1">startRecording</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">OutputFormat</span>.<span class="me1">THREE_GPP</span>, <span class="st0">&quot;.3gpp&quot;</span>, <span class="kw1">this</span>, mAudioSourceType, MediaRecorder.<span class="me1">AudioEncoder</span>.<span class="me1">AMR_NB</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>AUDIO_AAC_MP4.<span class="me1">equals</span><span class="br0">&#40;</span>mRequestedType<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        mRemainingTimeCalculator.<span class="me1">setBitRate</span><span class="br0">&#40;</span>BITRATE_3GPP<span class="br0">&#41;</span><span class="sy0">;</span>
                        mRecorder.<span class="me1">startRecording</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">OutputFormat</span>.<span class="me1">THREE_GPP</span>, <span class="st0">&quot;.3gpp&quot;</span>, <span class="kw1">this</span>, mAudioSourceType, MediaRecorder.<span class="me1">AudioEncoder</span>.<span class="me1">AAC</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>AUDIO_AAC_5POINT1_CHANNEL.<span class="me1">equals</span><span class="br0">&#40;</span>mRequestedType<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><span class="co1">//AAC  6-channel recording</span>
                        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw2">true</span> <span class="sy0">==</span> bSSRSupported<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                          mRemainingTimeCalculator.<span class="me1">setBitRate</span><span class="br0">&#40;</span>BITRATE_3GPP<span class="br0">&#41;</span><span class="sy0">;</span>
                          mRecorder.<span class="me1">setChannels</span><span class="br0">&#40;</span><span class="nu0">6</span><span class="br0">&#41;</span><span class="sy0">;</span>
                          mRecorder.<span class="me1">setSamplingRate</span><span class="br0">&#40;</span>SAMPLERATE_MULTI_CH<span class="br0">&#41;</span><span class="sy0">;</span>
                          mAudioSourceType <span class="sy0">=</span> MediaRecorder.<span class="me1">AudioSource</span>.<span class="me1">MIC</span><span class="sy0">;</span>
                          mRecorder.<span class="me1">startRecording</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">OutputFormat</span>.<span class="me1">THREE_GPP</span>, <span class="st0">&quot;.3gpp&quot;</span>, <span class="kw1">this</span>, mAudioSourceType, MediaRecorder.<span class="me1">AudioEncoder</span>.<span class="me1">AAC</span><span class="br0">&#41;</span><span class="sy0">;</span>
                        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                          <span class="kw1">throw</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+illegalargumentexception"><span class="kw3">IllegalArgumentException</span></a><span class="br0">&#40;</span><span class="st0">&quot;Invalid output file type requested&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                        <span class="br0">&#125;</span>
                    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>AUDIO_WAVE_6CH_LPCM.<span class="me1">equals</span><span class="br0">&#40;</span>mRequestedType<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><span class="co1">//WAVE LPCM  6-channel recording</span>
                        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw2">true</span> <span class="sy0">==</span> bSSRSupported<span class="br0">&#41;</span> <span class="br0">&#123;</span>
                          mRemainingTimeCalculator.<span class="me1">setBitRate</span><span class="br0">&#40;</span>BITRATE_3GPP<span class="br0">&#41;</span><span class="sy0">;</span>
                          mRecorder.<span class="me1">setChannels</span><span class="br0">&#40;</span><span class="nu0">6</span><span class="br0">&#41;</span><span class="sy0">;</span>
                          mRecorder.<span class="me1">setSamplingRate</span><span class="br0">&#40;</span>SAMPLERATE_MULTI_CH<span class="br0">&#41;</span><span class="sy0">;</span>
                          mAudioSourceType <span class="sy0">=</span> MediaRecorder.<span class="me1">AudioSource</span>.<span class="me1">MIC</span><span class="sy0">;</span>
                          mRecorder.<span class="me1">startRecording</span><span class="br0">&#40;</span>MediaRecorder.<span class="me1">OutputFormat</span>.<span class="me1">WAVE</span>, <span class="st0">&quot;.wav&quot;</span>, <span class="kw1">this</span>, mAudioSourceType, MediaRecorder.<span class="me1">AudioEncoder</span>.<span class="me1">LPCM</span><span class="br0">&#41;</span><span class="sy0">;</span>
                        <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                          <span class="kw1">throw</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+illegalargumentexception"><span class="kw3">IllegalArgumentException</span></a><span class="br0">&#40;</span><span class="st0">&quot;Invalid output file type requested&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                        <span class="br0">&#125;</span>
                    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
                        <span class="kw1">throw</span> <span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+illegalargumentexception"><span class="kw3">IllegalArgumentException</span></a><span class="br0">&#40;</span><span class="st0">&quot;Invalid output file type requested&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span>
&nbsp;
                    <span class="kw1">if</span> <span class="br0">&#40;</span>mMaxFileSize <span class="sy0">!=</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                        mRemainingTimeCalculator.<span class="me1">setFileSizeLimit</span><span class="br0">&#40;</span>
                                mRecorder.<span class="me1">sampleFile</span><span class="br0">&#40;</span><span class="br0">&#41;</span>, mMaxFileSize<span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="br0">&#125;</span>
                <span class="br0">&#125;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> R.<span class="me1">id</span>.<span class="me1">playButton</span><span class="sy0">:</span>
                stopAudioPlayback<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                mRecorder.<span class="me1">startPlayback</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> R.<span class="me1">id</span>.<span class="me1">stopButton</span><span class="sy0">:</span>
                mRecorder.<span class="me1">stop</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="co1">// Display the tips of stop record</span>
                mTitle.<span class="me1">setVisibility</span><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+view"><span class="kw3">View</span></a>.<span class="me1">VISIBLE</span><span class="br0">&#41;</span><span class="sy0">;</span>
                mTitle.<span class="me1">setText</span><span class="br0">&#40;</span>getResources<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getString</span><span class="br0">&#40;</span>R.<span class="me1">string</span>.<span class="me1">recording_stopped</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                mStateLED.<span class="me1">setVisibility</span><span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+view"><span class="kw3">View</span></a>.<span class="me1">VISIBLE</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> R.<span class="me1">id</span>.<span class="me1">acceptButton</span><span class="sy0">:</span>
                mRecorder.<span class="me1">stop</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                saveSampleAndExit<span class="br0">&#40;</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
                mRecorder.<span class="me1">reset</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> R.<span class="me1">id</span>.<span class="me1">discardButton</span><span class="sy0">:</span>
                mRecorder.<span class="me1">delete</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="co1">//prompt before exit</span>
                <span class="co1">//[SIMT-kun.mao-20130705] fix bug 8472 {</span>
                <span class="coMULTI">/*new AlertDialog.Builder(this)
                    .setTitle(R.string.app_name)
                    .setMessage(R.string.file_discard)
                    .setPositiveButton(R.string.button_ok,
                        new DialogInterface.OnClickListener() {
                            public void onClick(DialogInterface dialog, int which) {
                                dialog.dismiss();
                                finish();
                            }
                        }
                    )
                    .setCancelable(false)
                    .show(); */</span>
                updateMessage<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                Toast.<span class="me1">makeText</span><span class="br0">&#40;</span><span class="kw1">this</span>,R.<span class="me1">string</span>.<span class="me1">file_discard</span>,Toast.<span class="me1">LENGTH_SHORT</span><span class="br0">&#41;</span>.<span class="me1">show</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="co1">//[SIMT-kun.mao-20130705] fix bug 8472 }</span>
                <span class="kw1">break</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span></pre>
<pre class="code java">&nbsp;</pre>

</div>
<!-- EDIT3 SECTION "SoundRecorder.java" [6781-] -->